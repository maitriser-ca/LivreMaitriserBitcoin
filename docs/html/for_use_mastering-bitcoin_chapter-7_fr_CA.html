<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.17">
<title>Transactions et scripts avancés</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/*! Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment the following line when using as a custom stylesheet */
/* @import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"; */
html{font-family:sans-serif;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
b,strong{font-weight:bold}
abbr{font-size:.9em}
abbr[title]{cursor:help;border-bottom:1px dotted #dddddf;text-decoration:none}
dfn{font-style:italic}
hr{height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type=checkbox],input[type=radio]{padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,::before,::after{box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;line-height:1;position:relative;cursor:auto;-moz-tab-size:4;-o-tab-size:4;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:1px solid #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;border-radius:3px;box-shadow:0 1px 0 rgba(0,0,0,.2),inset 0 0 0 .1em #fff;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin:0 auto;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:flex;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border:1px solid #e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:hsla(0,0%,100%,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details{margin-left:1.25rem}
details>summary{cursor:pointer;display:block;position:relative;line-height:1.6;margin-bottom:.625rem;outline:none;-webkit-tap-highlight-color:transparent}
details>summary::-webkit-details-marker{display:none}
details>summary::before{content:"";border:solid transparent;border-left:solid;border-width:.3em 0 .3em .5em;position:absolute;top:.5em;left:-1.25rem;transform:translateX(15%)}
details[open]>summary::before{border:solid transparent;border-top:solid;border-width:.5em .3em 0;transform:translateY(15%)}
details>summary::after{content:"";width:1.25rem;height:1em;position:absolute;top:.3em;left:-1.25rem}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class=paragraph]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border:1px solid #e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border:1px solid #dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class=highlight],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos,pre.pygments .linenos{border-right:1px solid;opacity:.35;padding-right:.5em;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
pre.pygments span.linenos{display:inline-block;margin-right:.75em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans-serif;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;font-size:.85rem;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all>*>tr,table.stripes-odd>*>tr:nth-of-type(odd),table.stripes-even>*>tr:nth-of-type(even),table.stripes-hover>*>tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
li>p:empty:only-child::before{content:"";display:inline-block}
ul.checklist>li>p:first-child{margin-left:-1em}
ul.checklist>li>p:first-child>.fa-square-o:first-child,ul.checklist>li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist>li>p:first-child>input[type=checkbox]:first-child{margin-right:.25em}
ul.inline{display:flex;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:4px solid #fff;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt,summary{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt,summary{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]{border-bottom:1px dotted}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media amzn-kf8,print{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
</head>
<body class="article data-line-1">
<div id="header">
</div>
<div id="content">
<div class="sect1 data-line-3">
<h2 id="adv_transactions">Transactions et scripts avancés</h2>
<div class="sectionbody">
<div class="sect2 data-line-6">
<h3 id="ch07_intro">Présentation</h3>
<div class="paragraph data-line-8">
<p>Dans le chapitre précédent, nous avons présenté les éléments de base des transactions bitcoin et examiné le type de script de transaction le plus courant, le script P2PKH. Dans ce chapitre, nous examinerons des scripts plus avancés et comment nous pouvons les utiliser pour créer des transactions avec des conditions complexes.</p>
</div>
<div class="paragraph data-line-10">
<p>Tout d&#8217;abord, nous examinerons les scripts <em>multisignature</em>. Ensuite, nous examinerons le deuxième script de transaction le plus courant, <em>Pay-to-Script-Hash</em>, qui ouvre tout un monde de scripts complexes. Ensuite, nous examinerons de nouveaux opérateurs de script qui ajoutent une dimension temporelle au bitcoin, via les <em>timelocks</em> (verrouillage temporel). Enfin, nous examinerons les <em>Segregated Witness</em> (témoins séparés), une modification architecturale de la structure des transactions.</p>
</div>
</div>
<div class="sect2 data-line-13">
<h3 id="multisig">Multisignature</h3>
<div class="paragraph data-line-15">
<p>Les scripts multisignatures définissent une condition dans laquelle N clés publiques sont enregistrées dans le script et au moins M d&#8217;entre elles doivent fournir des signatures pour débloquer les fonds. Ceci est également connu sous le nom de schéma M-sur-N, où N est le nombre total de clés et M est le seuil de signatures requises pour la validation. Par exemple, une multisignature 2 sur 3 est celle où trois clés publiques sont répertoriées comme signataires potentiels et au moins deux d&#8217;entre elles doivent être utilisées pour créer des signatures pour une transaction valide afin de dépenser les fonds.</p>
</div>
<div class="paragraph data-line-17">
<p>À l&#8217;heure actuelle, les scripts multisignatures <em>standard</em> sont limités à un maximum de 3 clés publiques répertoriées, ce qui signifie que vous pouvez faire n&#8217;importe quoi d&#8217;une multisignature 1 sur 1 jusqu&#8217;à 3 sur 3 ou toute combinaison dans cette plage. La limitation à 3 clés répertoriées pourrait être levée au moment de la publication de ce livre, alors vérifiez la fonction <code>IsStandard()</code> pour voir ce qui est actuellement accepté par le réseau. Notez que la limite de 3 clés s&#8217;applique uniquement aux scripts multisignatures standard (également appelés "nus (bare en anglais)"), et non aux scripts multisignatures enveloppés dans un script Pay-to-Script-Hash (P2SH). Les scripts multisignatures P2SH sont limités à 15 clés, permettant jusqu&#8217;à 15 multisignatures sur 15. Cette limitation est également imposée par la fonction <code>IsStandard()</code>. Nous en apprendrons davantage sur P2SH dans <a href="#p2sh">Pay-to-Script-Hash (P2SH)</a>.</p>
</div>
<div class="paragraph data-line-19">
<p>La forme générale d&#8217;un script de verrouillage définissant une condition multisignature M-de-N est :</p>
</div>
<div class="listingblock data-line-21">
<div class="content">
<pre>M &lt;Public Key 1&gt; &lt;Public Key 2&gt; ... &lt;Public Key N&gt; N CHECKMULTISIG</pre>
</div>
</div>
<div class="paragraph data-line-25">
<p>où N est le nombre total de clés publiques répertoriées et M est le seuil de signatures requises pour dépenser la sortie.</p>
</div>
<div class="paragraph data-line-27">
<p>Un script de verrouillage définissant une condition multisignature 2 sur 3 ressemble à ceci :</p>
</div>
<div class="listingblock data-line-29">
<div class="content">
<pre>2 &lt;Public Key A&gt; &lt;Public Key B&gt; &lt;Public Key C&gt; 3 CHECKMULTISIG</pre>
</div>
</div>
<div class="paragraph data-line-33">
<p>Le script de verrouillage précédent peut se contenter d&#8217;un script de déverrouillage contenant n&#8217;importe quelle combinaison de deux signatures issues des clés privées correspondant aux trois clés publiques listées :</p>
</div>
<div class="listingblock data-line-35">
<div class="content">
<pre>&lt;Signature B&gt; &lt;Signature C&gt;</pre>
</div>
</div>
<div class="paragraph data-line-39">
<p>Les deux scripts ensemble formeraient le script de validation combiné :</p>
</div>
<div class="listingblock data-line-41">
<div class="content">
<pre>&lt;Signature B&gt; &lt;Signature C&gt; 2 &lt;Public Key A&gt; &lt;Public Key B&gt; &lt;Public Key C&gt; 3 CHECKMULTISIG</pre>
</div>
</div>
<div class="paragraph data-line-45">
<p>Lorsqu&#8217;il est exécuté, ce script combiné sera évalué à TRUE si, et seulement si, le script de déverrouillage correspond aux conditions définies par le script de verrouillage. Dans ce cas, la condition est de savoir si le script de déverrouillage possède une signature valide à partir des deux clés privées qui correspondent à deux des trois clés publiques définies comme une charge.</p>
</div>
<div class="sect3 data-line-48">
<h4 id="multisig_bug">Un bogue dans l&#8217;exécution de CHECKMULTISIG</h4>
<div class="paragraph data-line-50">
<p>Il y a un bug dans l&#8217;exécution de <code>CHECKMULTISIG</code> qui nécessite une légère solution de contournement. Lorsque <code>CHECKMULTISIG</code> s&#8217;exécute, il doit consommer M`N`2 éléments sur la pile en tant que paramètres. Cependant, en raison du bogue, <code>CHECKMULTISIG</code> affichera une valeur supplémentaire ou une valeur de plus que prévu.</p>
</div>
<div class="paragraph data-line-52">
<p>Examinons cela plus en détail à l&#8217;aide de l&#8217;exemple de validation précédent :</p>
</div>
<div class="listingblock data-line-54">
<div class="content">
<pre>&lt;Signature B&gt; &lt;Signature C&gt; 2 &lt;Public Key A&gt; &lt;Public Key B&gt; &lt;Public Key C&gt; 3 CHECKMULTISIG</pre>
</div>
</div>
<div class="paragraph data-line-58">
<p>Tout d&#8217;abord, <code>CHECKMULTISIG</code> affiche l&#8217;élément supérieur, qui est <code>N</code> (dans cet exemple "3"). Ensuite, il affiche <code>N</code> éléments, qui sont les clés publiques pouvant signer. Dans cet exemple, les clés publiques A, B et C. Ensuite, un élément apparaît, qui est <code>M</code>, le quorum (combien de signatures sont nécessaires). Ici M = 2. À ce stade, <code>CHECKMULTISIG</code> devrait faire apparaître les éléments finaux <code>M</code>, qui sont les signatures, et voir s&#8217;ils sont valides. Cependant, malheureusement, un bogue dans l&#8217;implémentation fait que <code>CHECKMULTISIG</code> affiche un élément de plus (M+1 total) qu&#8217;il ne le devrait. L&#8217;élément supplémentaire n&#8217;est pas pris en compte lors de la vérification des signatures, il n&#8217;a donc aucun effet direct sur <code>CHECKMULTISIG</code> lui-même. Cependant, une valeur supplémentaire doit être présente car si elle n&#8217;est pas présente, lorsque <code>CHECKMULTISIG</code> tente d&#8217;apparaître sur une pile vide, cela provoquera une erreur de pile et un échec du script (marquant la transaction comme invalide). Comme l&#8217;élément supplémentaire n&#8217;est pas pris en compte, il peut s&#8217;agir de n&#8217;importe quoi, mais habituellement <code>0</code> est utilisé.</p>
</div>
<div class="paragraph data-line-60">
<p>Parce que ce bogue est devenu une partie des règles de consensus, il doit maintenant être répliqué pour toujours. Par conséquent, la validation correcte du script ressemblerait à ceci :</p>
</div>
<div class="listingblock data-line-62">
<div class="content">
<pre>0 &lt;Signature B&gt; &lt;Signature C&gt; 2 &lt;Public Key A&gt; &lt;Public Key B&gt; &lt;Public Key C&gt; 3 CHECKMULTISIG</pre>
</div>
</div>
<div class="paragraph data-line-66">
<p>Ainsi le script de déverrouillage réellement utilisé en multisig n&#8217;est pas :</p>
</div>
<div class="listingblock data-line-68">
<div class="content">
<pre>&lt;Signature B&gt; &lt;Signature C&gt;</pre>
</div>
</div>
<div class="paragraph data-line-72">
<p>mais à la place c&#8217;est :</p>
</div>
<div class="listingblock data-line-74">
<div class="content">
<pre>0 &lt;Signature B&gt; &lt;Signature C&gt;</pre>
</div>
</div>
<div class="paragraph data-line-78">
<p>À partir de maintenant, si vous voyez un script de déverrouillage multisig, vous devriez vous attendre à voir un <code>0</code> supplémentaire au début, dont le seul but est de contourner un bogue qui est accidentellement devenu une règle de consensus.</p>
</div>
</div>
</div>
<div class="sect2 data-line-81">
<h3 id="p2sh">Pay-to-Script-Hash (P2SH)</h3>
<div class="paragraph data-line-83">
<p>Pay- to-Script-Hash (P2SH) a été introduit en 2012 en tant que nouveau type de transaction puissant qui simplifie grandement l&#8217;utilisation de scripts de transaction complexes. Pour expliquer le besoin de P2SH, regardons un exemple pratique.</p>
</div>
<div class="paragraph data-line-85">
<p>("Pay-to-Script-Hash (P2SH)", "exemple d&#8217;import/export")Dans <a href="#ch01_intro_what_is_bitcoin">[ch01_intro_what_is_bitcoin]</a> nous avons présenté Mohammed, un importateur d&#8217;électronique basé à Dubaï. La société de Mohammed utilise largement la fonction multisignature de Bitcoin pour ses comptes d&#8217;entreprise. Les scripts multisignatures sont l&#8217;une des utilisations les plus courantes des capacités de script avancées de Bitcoin et constituent une fonctionnalité très puissante. La société de Mohammed utilise un script multisignature pour tous les paiements des clients, connu en termes comptables sous le nom de "comptes débiteurs ou recevables". Avec le schéma multisignature, tous les paiements effectués par les clients sont verrouillés de telle manière qu&#8217;ils nécessitent au moins deux signatures pour être libérés, de Mohammed et de l&#8217;un de ses partenaires ou de son avocat qui dispose d&#8217;une clé de secours. Un système multisignature comme celui-ci offre des contrôles de gouvernance d&#8217;entreprise et protège contre le vol, le détournement de fonds ou la perte.</p>
</div>
<div class="paragraph data-line-87">
<p>Le script résultant est assez long et ressemble à ceci :</p>
</div>
<div class="listingblock data-line-89">
<div class="content">
<pre>2 &lt;Mohammed's Public Key&gt; &lt;Partner1 Public Key&gt; &lt;Partner2 Public Key&gt; &lt;Partner3 Public Key&gt; &lt;Attorney Public Key&gt; 5 CHECKMULTISIG</pre>
</div>
</div>
<div class="paragraph data-line-93">
<p>Bien que les scripts multisignatures soient une fonctionnalité puissante, ils sont lourds à utiliser. Compte tenu du script précédent, Mohammed devrait communiquer ce script à chaque client avant le paiement. Chaque client devrait utiliser un logiciel spécial de portefeuille bitcoin avec la possibilité de créer des scripts de transaction personnalisés, et chaque client devrait comprendre comment créer une transaction à l&#8217;aide de scripts personnalisés. De plus, la transaction résultante serait environ cinq fois plus importante qu&#8217;une simple transaction de paiement, car ce script contient des clés publiques très longues. Le fardeau de cette transaction extra-large serait supporté par le client sous la forme de frais. Enfin, un gros script de transaction comme celui-ci serait transporté dans l&#8217;UTXO défini dans la RAM de chaque nœud complet, jusqu&#8217;à ce qu&#8217;il soit dépensé. Tous ces problèmes rendent difficile l&#8217;utilisation de scripts de verrouillage complexes dans la pratique.</p>
</div>
<div class="paragraph data-line-95">
<p>P2SH a été développé pour résoudre ces difficultés pratiques et rendre l&#8217;utilisation de scripts complexes aussi simple qu&#8217;un paiement à une adresse Bitcoin. Avec les paiements P2SH, le script de verrouillage complexe est remplacé par son empreinte numérique, un hachage cryptographique. Lorsqu&#8217;une transaction tentant de dépenser l&#8217;UTXO est présentée ultérieurement, elle doit contenir le script correspondant au hachage, en plus du script de déverrouillage. En termes simples, P2SH signifie "payer à un script correspondant à ce hachage, un script qui sera présenté plus tard lorsque cette sortie sera dépensée".</p>
</div>
<div class="paragraph data-line-97">
<p>Dans les transactions P2SH, le script de verrouillage qui est remplacé par un hachage est appelé <em>redeem script</em> ou <em>script de rachat</em> car il est présenté au système au moment du rachat plutôt que comme un script de verrouillage. <a href="#without_p2sh">Script complexe sans P2SH</a> affiche le script sans P2SH et <a href="#with_p2sh">Script complexe comme P2SH</a> montre le même script encodé avec P2SH.</p>
</div>
<table id="without_p2sh" class="tableblock frame-all grid-all stretch data-line-101">
<caption class="title">Table 1. Script complexe sans P2SH</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Script de verrouillage</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2 PubKey1 PubKey2 PubKey3 PubKey4 PubKey5 5 CHECKMULTISIG</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Script de déverrouillage</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0 Sig1 Sig2</p></td>
</tr>
</tbody>
</table>
<table id="with_p2sh" class="tableblock frame-all grid-all stretch data-line-108">
<caption class="title">Table 2. Script complexe comme P2SH</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Script de rachat</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2 PubKey1 PubKey2 PubKey3 PubKey4 PubKey5 5 CHECKMULTISIG</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Script de verrouillage</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">HASH160 &lt;20-byte hash of redeem script&gt; EQUAL</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Script de déverrouillage</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0 Sig1 Sig2 &lt;redeem script&gt;</p></td>
</tr>
</tbody>
</table>
<div class="paragraph data-line-114">
<p>Comme vous pouvez le voir dans les tableaux, avec P2SH, le script complexe qui détaille les conditions de dépense de la sortie (script de rachat) n&#8217;est pas présenté dans le script de verrouillage. Au lieu de cela, seul un hachage de celui-ci se trouve dans le script de verrouillage et le script de rachat lui-même est présenté plus tard, dans le cadre du script de déverrouillage lorsque la sortie est dépensée. Cela déplace le fardeau des frais et de la complexité de l&#8217;expéditeur (qui crée la transaction) vers le destinataire (qui déverrouille et dépense la transaction).</p>
</div>
<div class="paragraph data-line-116">
<p>Examinons la société de Mohammed, le script multisignature complexe et les scripts P2SH qui en résultent.</p>
</div>
<div class="paragraph data-line-118">
<p>Tout d&#8217;abord, le script multisignature que la société de Mohammed utilise pour tous les paiements entrants des clients :</p>
</div>
<div class="listingblock data-line-120">
<div class="content">
<pre>2 &lt;Mohammed's Public Key&gt; &lt;Partner1 Public Key&gt; &lt;Partner2 Public Key&gt; &lt;Partner3 Public Key&gt; &lt;Attorney Public Key&gt; 5 CHECKMULTISIG</pre>
</div>
</div>
<div class="paragraph data-line-124">
<p>Si les espaces réservés sont remplacés par des clés publiques réelles (affichées ici sous forme de nombres de 520 bits commençant par 04), vous pouvez voir que ce script devient très long :</p>
</div>
<div class="listingblock data-line-126">
<div class="content">
<pre>2
04C16B8698A9ABF84250A7C3EA7EEDEF9897D1C8C6ADF47F06CF73370D74DCCA01CDCA79DCC5C395D7EEC6984D83F1F50C900A24DD47F569FD4193AF5DE762C58704A2192968D8655D6A935BEAF2CA23E3FB87A3495E7AF308EDF08DAC3C1FCBFC2C75B4B0F4D0B1B70CD2423657738C0C2B1D5CE65C97D78D0E34224858008E8B49047E63248B75DB7379BE9CDA8CE5751D16485F431E46117B9D0C1837C9D5737812F393DA7D4420D7E1A9162F0279CFC10F1E8E8F3020DECDBC3C0DD389D99779650421D65CBD7149B255382ED7F78E946580657EE6FDA162A187543A9D85BAAA93A4AB3A8F044DADA618D087227440645ABE8A35DA8C5B73997AD343BE5C2AFD94A5043752580AFA1ECED3C68D446BCAB69AC0BA7DF50D56231BE0AABF1FDEEC78A6A45E394BA29A1EDF518C022DD618DA774D207D137AAB59E0B000EB7ED238F4D800 5 CHECKMULTISIG</pre>
</div>
</div>
<div class="paragraph data-line-131">
<p>Ce script entier peut à la place être représenté par un hachage cryptographique de 20 octets, en appliquant d&#8217;abord l&#8217;algorithme de hachage SHA256, puis en appliquant l&#8217;algorithme RIPEMD160 sur le résultat.</p>
</div>
<div class="paragraph data-line-133">
<p>Nous utilisons <code>libbitcoin-explorer</code> (bx) sur la ligne de commande pour produire le hachage du script, comme suit :</p>
</div>
<div class="listingblock data-line-135">
<div class="content">
<pre>echo \
2 \
[04C16B8698A9ABF84250A7C3EA7EEDEF9897D1C8C6ADF47F06CF73370D74DCCA01CDCA79DCC5C395D7EEC6984D83F1F50C900A24DD47F569FD4193AF5DE762C587] \
[04A2192968D8655D6A935BEAF2CA23E3FB87A3495E7AF308EDF08DAC3C1FCBFC2C75B4B0F4D0B1B70CD2423657738C0C2B1D5CE65C97D78D0E34224858008E8B49] \
[047E63248B75DB7379BE9CDA8CE5751D16485F431E46117B9D0C1837C9D5737812F393DA7D4420D7E1A9162F0279CFC10F1E8E8F3020DECDBC3C0DD389D9977965] \
[0421D65CBD7149B255382ED7F78E946580657EE6FDA162A187543A9D85BAAA93A4AB3A8F044DADA618D087227440645ABE8A35DA8C5B73997AD343BE5C2AFD94A5] \
[043752580AFA1ECED3C68D446BCAB69AC0BA7DF50D56231BE0AABF1FDEEC78A6A45E394BA29A1EDF518C022DD618DA774D207D137AAB59E0B000EB7ED238F4D800] \
5 CHECKMULTISIG \
| bx script-encode | bx sha256 | bx ripemd160
54c557e07dde5bb6cb791c7a540e0a4796f5e97e</pre>
</div>
</div>
<div class="paragraph data-line-148">
<p>La série de commandes ci-dessus encode d&#8217;abord le script de rachat multisig de Mohammed en tant que script bitcoin sérialisé encodé en hexadécimal. La commande <code>bx</code> suivante calcule le hachage SHA256 de cela. La prochaine commande <code>bx</code> hache à nouveau avec RIPEMD160, produisant le hachage de script final :</p>
</div>
<div class="paragraph data-line-150">
<p>Le hachage de 20 octets du script de rachat de Mohammed est :</p>
</div>
<div class="listingblock data-line-152">
<div class="content">
<pre>54c557e07dde5bb6cb791c7a540e0a4796f5e97e</pre>
</div>
</div>
<div class="paragraph data-line-156">
<p>Une transaction P2SH verrouille la sortie sur ce hachage au lieu du script de rachat plus long, en utilisant le script de verrouillage :</p>
</div>
<div class="listingblock data-line-158">
<div class="content">
<pre>HASH160 54c557e07dde5bb6cb791c7a540e0a4796f5e97e EQUAL</pre>
</div>
</div>
<div class="paragraph data-line-162">
<p>qui, comme vous pouvez le voir, est beaucoup plus courte. Au lieu de "payer à ce script multisignature à 5 clés", la transaction équivalente à P2SH est "payer à un script avec ce hachage". Un client effectuant un paiement à la société de Mohammed n&#8217;a qu&#8217;à inclure ce script de verrouillage beaucoup plus court dans son paiement. Lorsque Mohammed et ses partenaires veulent dépenser cet UTXO, ils doivent présenter le script de rachat original (celui dont le hachage a verrouillé l&#8217;UTXO) et les signatures nécessaires pour le déverrouiller, comme ceci :</p>
</div>
<div class="listingblock data-line-164">
<div class="content">
<pre>&lt;Sig1&gt; &lt;Sig2&gt; &lt;2 PK1 PK2 PK3 PK4 PK5 5 CHECKMULTISIG&gt;</pre>
</div>
</div>
<div class="paragraph data-line-168">
<p>Les deux scripts sont combinés en deux étapes. Tout d&#8217;abord, le script de rachat est vérifié par rapport au script de verrouillage pour s&#8217;assurer que le hachage correspond :</p>
</div>
<div class="listingblock data-line-170">
<div class="content">
<pre>&lt;2 PK1 PK2 PK3 PK4 PK5 5 CHECKMULTISIG&gt; HASH160 &lt;redeem scriptHash&gt; EQUAL</pre>
</div>
</div>
<div class="paragraph data-line-173">
<p>Si le hachage du script de rachat correspond, le script de déverrouillage est exécuté de lui-même pour déverrouiller le script de rachat :</p>
</div>
<div class="listingblock data-line-175">
<div class="content">
<pre>&lt;Sig1&gt; &lt;Sig2&gt; 2 PK1 PK2 PK3 PK4 PK5 5 CHECKMULTISIG</pre>
</div>
</div>
<div class="paragraph data-line-179">
<p>Presque tous les scripts décrits dans ce chapitre ne peuvent être implémentés qu&#8217;en tant que scripts P2SH. Par exemple, un script de verrouillage multisignature standard 2 sur 5 ne peut pas être utilisé directement dans le script de verrouillage d&#8217;un UTXO, car <code>IsStandard()</code> invaliderait la transaction. Pour se conformer, un script de verrouillage P2SH peut être utilisé à la place, comme vu ci-dessus. Une transaction qui comprend alors un script de déverrouillage P2SH peut être utilisée pour racheter cet UTXO et sera valide tant qu&#8217;elle ne contient pas plus de 15 clés publiques. </p>
</div>
<div class="admonitionblock tip data-line-182">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph data-line-183">
<p>N&#8217;oubliez pas qu&#8217;en raison de la politique définie par la fonction <code>IsStandard()</code> au moment de la rédaction de cet article, les scripts multisignatures standard sont limités à 3 clés publiques répertoriées au maximum, tandis que les scripts P2SH sont limités à 15 clés publiques répertoriées au maximum. Les scripts multisignatures standard peuvent invalider les transactions au moyen de leur script de verrouillage <em>ou</em> de déverrouillage, tandis que les scripts P2SH peuvent invalider les transactions au moyen de leur script de déverrouillage <em>uniquement</em>. En effet, <code>IsStandard()</code> n&#8217;a aucun moyen de savoir si un hachage d&#8217;un script de rachat dans un script de verrouillage inclut plus de signatures que la limite de taille actuellement imposée, il ne peut donc observer que les scripts de déverrouillage dans les entrées de transaction.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect3 data-line-186">
<h4 id="_adresses_p2sh">Adresses P2SH</h4>
<div class="paragraph data-line-188">
<p>Une autre partie importante de la fonctionnalité P2SH est la possibilité d&#8217;encoder un hachage de script en tant qu&#8217;adresse, comme défini dans BIP-13. Les adresses P2SH sont des encodages Base58Check du hachage de 20 octets d&#8217;un script, tout comme les adresses Bitcoin sont des encodages Base58Check du hachage de 20 octets d&#8217;une clé publique. Les adresses P2SH utilisent le préfixe de version "5", ce qui donne des adresses encodées en Base58Check qui commencent par un "3".</p>
</div>
<div class="paragraph data-line-190">
<p>Par exemple, le script complexe de Mohammed, haché et encodé en Base58Check comme une adresse P2SH, devient 39RF6JqABiHdYHkfChV6USGMe6Nsr66Gzw. Nous pouvons le confirmer avec la commande bx :</p>
</div>
<div class="listingblock data-line-192">
<div class="content">
<pre>echo \
'54c557e07dde5bb6cb791c7a540e0a4796f5e97e'\
 | bx address-encode -v 5
39RF6JqABiHdYHkfChV6USGMe6Nsr66Gzw</pre>
</div>
</div>
<div class="paragraph data-line-200">
<p>Maintenant, Mohammed peut donner cette "adresse" à ses clients et ils peuvent utiliser presque n&#8217;importe quel portefeuille bitcoin pour effectuer un paiement simple, comme s&#8217;il s&#8217;agissait d&#8217;une adresse Bitcoin. Le préfixe 3 leur donne un indice qu&#8217;il s&#8217;agit d&#8217;un type d&#8217;adresse spécial, celui correspondant à un script au lieu d&#8217;une clé publique, mais sinon cela fonctionne exactement de la même manière qu&#8217;un paiement à une adresse Bitcoin.</p>
</div>
<div class="paragraph data-line-202">
<p>Les adresses P2SH cachent toute la complexité, de sorte que la personne effectuant un paiement ne voit pas le script.</p>
</div>
</div>
<div class="sect3 data-line-204">
<h4 id="_avantages_du_p2sh">Avantages du P2SH</h4>
<div class="paragraph data-line-206">
<p>La fonction P2SH offre les avantages suivants par rapport à l&#8217;utilisation directe de scripts complexes dans le verrouillage des sorties :</p>
</div>
<div class="ulist data-line-208">
<ul>
<li class="data-line-208">
<p>Les scripts complexes sont remplacés par des empreintes digitales plus courtes dans la sortie de la transaction, ce qui réduit la taille de la transaction.</p>
</li>
<li class="data-line-209">
<p>Les scripts peuvent être codés comme une adresse, de sorte que l&#8217;expéditeur et le portefeuille de l&#8217;expéditeur n&#8217;ont pas besoin d&#8217;ingénierie complexe pour implémenter P2SH.</p>
</li>
<li class="data-line-210">
<p>P2SH transfère le fardeau de la construction du script au destinataire, pas à l&#8217;expéditeur.</p>
</li>
<li class="data-line-211">
<p>P2SH déplace la charge de stockage des données pour le script long de la sortie (qui en plus d&#8217;être stockée sur la chaîne de blocs est dans l&#8217;ensemble UTXO) vers l&#8217;entrée (uniquement stockée sur la chaîne de blocs).</p>
</li>
<li class="data-line-212">
<p>P2SH déplace la charge de stockage des données pour le script long du moment présent (paiement) à un moment futur (lorsqu&#8217;il est dépensé).</p>
</li>
<li class="data-line-213">
<p>P2SH transfère les frais de transaction plus élevés d&#8217;un long script de l&#8217;expéditeur au destinataire, qui doit inclure le long script d&#8217;échange pour le dépenser.</p>
</li>
</ul>
</div>
</div>
<div class="sect3 data-line-215">
<h4 id="_utiliser_le_script_et_la_validation">Utiliser le script et la validation</h4>
<div class="paragraph data-line-217">
<p>Avant la version 0.9.2 du client Bitcoin Core, Pay-to-Script-Hash était limité aux types standard de scripts de transaction bitcoin, par la fonction IsStandard(). Cela signifie que le script d&#8217;échange présenté dans la transaction de dépenses ne peut être que l&#8217;un des types standard : P2PK, P2PKH ou multisig.</p>
</div>
<div class="paragraph data-line-219">
<p>Depuis la version 0.9.2 du client Bitcoin Core, les transactions P2SH peuvent contenir n&#8217;importe quel script valide, ce qui rend la norme P2SH beaucoup plus flexible et permet d&#8217;expérimenter de nombreux types de transactions nouveaux et complexes.</p>
</div>
<div class="paragraph data-line-221">
<p>Vous ne pouvez pas mettre un P2SH dans un script de rachat P2SH, car la spécification P2SH n&#8217;est pas récursive. Aussi, bien qu&#8217;il soit techniquement possible d&#8217;inclure <code>RETURN</code> (voir <a href="#op_return">Sortie d&#8217;enregistrement de données (RETURN)</a>) dans un script de rachat, comme rien dans les règles ne vous empêche de le faire, cela n&#8217;a aucune utilité pratique car l&#8217;exécution de <code>RETURN</code> lors de la validation entraînera le marquage de la transaction comme invalide.</p>
</div>
<div class="paragraph data-line-223">
<p>Notez que, comme le script de rachat n&#8217;est pas présenté au réseau tant que vous n&#8217;essayez pas de dépenser une sortie P2SH, si vous verrouillez une sortie avec le hachage d&#8217;un script de rachat invalide, elle sera traitée malgré tout. L&#8217;UTXO sera verrouillé avec succès. Cependant, vous ne pourrez pas le dépenser car la transaction de dépense, qui inclut le script d&#8217;échange, ne sera pas acceptée car il s&#8217;agit d&#8217;un script invalide. Cela crée un risque, car vous pouvez verrouiller des bitcoins dans un P2SH qui ne pourra pas être dépensé plus tard. Le réseau acceptera le script de verrouillage P2SH même s&#8217;il correspond à un script de rachat invalide, car le hachage du script ne donne aucune indication sur le script qu&#8217;il représente.</p>
</div>
<div class="admonitionblock warning data-line-226">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph data-line-227">
<p>Les scripts de verrouillage P2SH contiennent le hachage d&#8217;un script de rachat, qui ne donne aucun indice quant au contenu du script de rachat lui-même. La transaction P2SH sera considérée comme valide et acceptée même si le script de rachat est invalide. Vous pourriez accidentellement verrouiller le bitcoin de telle sorte qu&#8217;il ne puisse plus être dépensé.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2 data-line-233">
<h3 id="op_return">Sortie d&#8217;enregistrement de données (RETURN)</h3>
<div class="paragraph data-line-235">
<p>Les bitcoins sont distribués et Le grand livre horodaté, la chaîne de blocs, a des utilisations potentielles bien au-delà des paiements. De nombreux développeurs ont essayé d&#8217;utiliser le langage de script de transaction pour tirer parti de la sécurité et de la résilience du système pour des applications telles que les services de notaire numérique, les certificats d&#8217;actions et les contrats intelligents. Les premières tentatives d&#8217;utilisation du langage de script de bitcoin à ces fins impliquaient la création de sorties de transaction qui enregistraient des données sur la chaîne de blocs; par exemple, pour enregistrer une empreinte digitale d&#8217;un fichier de manière à ce que n&#8217;importe qui puisse établir la preuve de l&#8217;existence de ce fichier à une date précise par référence à cette transaction.</p>
</div>
<div class="paragraph data-line-237">
<p>L&#8217;utilisation de la chaîne de blocs de Bitcoin pour stocker les données non liées aux paiements en bitcoins sont un sujet controversé. De nombreux développeurs considèrent cette utilisation abusive et veulent la décourager. D&#8217;autres y voient une démonstration des puissantes capacités de la technologie chaîne de blocs et souhaitent encourager une telle expérimentation. Ceux qui s&#8217;opposent à l&#8217;inclusion de données de non-paiement soutiennent que cela provoque un "gonflement de la chaîne de blocs", ce qui impose à ceux qui exécutent des nœuds Bitcoin complets de supporter le coût du stockage sur disque pour les données que la chaîne de blocs n&#8217;était pas destinée à transporter. De plus, de telles transactions créent des UTXO qui ne peuvent pas être dépensés, en utilisant l&#8217;adresse Bitcoin de destination comme un champ libre de 20 octets. Parce que l&#8217;adresse est utilisée pour les données, elle ne correspond pas à une clé privée et l&#8217;UTXO résultant ne peut <em>jamais</em> être dépensé ; c&#8217;est un faux paiement. Ces transactions qui ne peuvent jamais être dépensées ne sont donc jamais supprimées de l&#8217;ensemble UTXO et entraînent une augmentation permanente de la taille de la base de données UTXO, ou un "gonflement".</p>
</div>
<div class="paragraph data-line-239">
<p>Dans la version 0.9 du client Bitcoin Core, un compromis a été trouvé avec l&#8217;introduction de l&#8217;opérateur RETURN. <code>RETURN</code> permet aux développeurs d&#8217;ajouter 80 octets de données de non-paiement à une sortie de transaction. Cependant, contrairement à l&#8217;utilisation de "faux" UTXO, l&#8217;opérateur <code>RETURN</code> crée une sortie explicitement et <em>manifestement indépensable</em>, qui n&#8217;a pas besoin d&#8217;être stockée dans l&#8217;ensemble UTXO. Les sorties <code>RETURN</code> sont enregistrées sur la chaîne de blocs, elles consomment donc de l&#8217;espace disque et contribuent à l&#8217;augmentation de la taille de la chaîne de blocs, mais elles ne sont pas stockées dans l&#8217;ensemble UTXO et ne gonflent donc pas le bassin de mémoire UTXO et ne surchargent pas les nœuds complets avec plus de dépenses en RAM.</p>
</div>
<div class="paragraph data-line-241">
<p>Les scripts <code>RETURN</code> ressemblent à ceci :</p>
</div>
<div class="listingblock data-line-243">
<div class="content">
<pre>RETURN &lt;data&gt;</pre>
</div>
</div>
<div class="paragraph data-line-247">
<p>La portion de données est limitée à 80 octets et représente le plus souvent un hachage, comme la sortie de l&#8217;algorithme SHA256 (32 octets). De nombreuses applications mettent un préfixe devant les données pour aider à identifier l&#8217;application. Par exemple, le service de notarisation numérique <a href="https://proofofexistence.com" data-href="https://proofofexistence.com">Preuve d&#8217;existence</a> utilise le préfixe de 8 octets DOCPROOF, qui est encodé en ASCII sous la forme <code>44 4f 43 50 52 4f 4f 46</code> en hexadécimal.</p>
</div>
<div class="paragraph data-line-249">
<p>Gardez à l&#8217;esprit qu&#8217;il n&#8217;y a pas de "script de déverrouillage" correspondant à <code>RETURN</code> qui pourrait éventuellement être utilisé pour "passer" une sortie RETURN. L&#8217;intérêt de <code>RETURN</code> est que vous ne pouvez pas dépenser l&#8217;argent bloqué dans cette sortie, et donc il n&#8217;a pas besoin d&#8217;être conservé dans l&#8217;ensemble UTXO comme potentiellement dépensable - <code>RETURN</code> est <em>manifestement indépensable</em>. <code>RETURN</code> est généralement une sortie avec un montant de zéro bitcoin, car tout bitcoin attribué à une telle sortie est effectivement perdu à jamais. Si un <code>RETURN</code> est référencé comme entrée dans une transaction, le moteur de validation de script arrêtera l&#8217;exécution du script de validation et marquera la transaction comme invalide. L&#8217;exécution de <code>RETURN</code> provoque essentiellement le script "RETURN" avec un <code>FALSE</code> et s&#8217;arrête. Ainsi, si vous référencez accidentellement une sortie <code>RETURN</code> comme entrée dans une transaction, cette transaction n&#8217;est pas valide.</p>
</div>
<div class="paragraph data-line-251">
<p>Une transaction standard (c&#8217;est-à-dire conforme aux vérifications IsStandard()) ne peut avoir qu&#8217;une seule sortie RETURN. Cependant, une seule sortie <code>RETURN</code> peut être combinée dans une transaction avec des sorties de tout autre type.</p>
</div>
<div class="paragraph data-line-253">
<p>Deux nouvelles options de ligne de commande ont été ajoutées dans Bitcoin Core à partir de la version 0.10. L&#8217;option <code>datacarrier</code> contrôle le relais et l&#8217;exploration des transactions RETURN, avec la valeur par défaut définie à "1" pour les autoriser. L&#8217;option <code>datacarriersize</code> prend un argument numérique spécifiant la taille maximale en octets du script RETURN, 83 octets par défaut, ce qui permet un maximum de 80 octets de données <code>RETURN</code> plus un octet d&#8217;opcode <code>RETURN</code> et deux octets de Opcode PUSHDATA.</p>
</div>
<div class="admonitionblock note data-line-256">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph data-line-257">
<p>RETURN a été initialement proposé avec une limite de 80 octets, mais la limite a été réduite à 40 octets lorsque la fonctionnalité a été publiée. En février 2015, dans la version 0.10 de Bitcoin Core, la limite a été relevée à 80 octets. Les nœuds peuvent choisir de ne pas relayer ou exploiter RETURN, ou uniquement de relayer et d&#8217;exploiter <code>RETURN</code> contenant moins de 80 octets de données.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2 data-line-260">
<h3 id="_verrous_temporels">Verrous temporels</h3>
<div class="paragraph data-line-262">
<p>Les verrous temporels (ou timelocks) sont des restrictions sur les transactions ou les sorties qui ne permettent de dépenser qu&#8217;après un certain temps. Bitcoin a eu une fonction de verrouillage du temps au niveau de la transaction depuis le début. Il est implémenté par le champ <code>nLocktime</code> dans une transaction. Deux nouvelles fonctionnalités de verrou temporel ont été introduites fin 2015 et mi-2016 qui offrent des verrous temporels de niveau UTXO. Ce sont <code>CHECKLOCKTIMEVERIFY</code> et CHECKSEQUENCEVERIFY.</p>
</div>
<div class="paragraph data-line-264">
<p>Les verrous temporels sont utiles pour postdater les transactions et verrouiller les fonds à une date future. Plus important encore, les verrous temporels étendent les scripts bitcoin dans la dimension du temps, ouvrant la porte à des contrats intelligents complexes en plusieurs étapes.</p>
</div>
<div class="sect3 data-line-267">
<h4 id="transaction_locktime_nlocktime">Temps de verrouillage des transactions (nLocktime)</h4>
<div class="paragraph data-line-269">
<p>Depuis le début, Bitcoin a eu une fonction de timelock au niveau de la transaction. L&#8217;heure de verrouillage de la transaction est un paramètre au niveau de la transaction (un champ dans la structure des données de la transaction) qui définit la première heure à laquelle une transaction est valide et peut être relayée sur le réseau ou ajoutée à la chaîne de blocs. Le verrou temporel est également connu sous le nom de <code>nLocktime</code> à partir du nom de variable utilisé dans la base de code Bitcoin Core. Il est défini sur zéro dans la plupart des transactions pour indiquer une propagation et une exécution immédiates. Si <code>nLocktime</code> est différent de zéro et inférieur à 500 millions, il est interprété comme une hauteur de bloc, ce qui signifie que la transaction n&#8217;est pas valide et n&#8217;est pas relayée ou incluse dans la chaîne de blocs avant la hauteur de bloc spécifiée. S&#8217;il est supérieur ou égal à 500 millions, il est interprété comme un horodatage Unix Epoch (secondes depuis le 1er janvier 1970) et la transaction n&#8217;est pas valide avant l&#8217;heure spécifiée. Les transactions avec <code>nLocktime</code> spécifiant un bloc ou une heure future doivent être conservées par le système d&#8217;origine et transmises au réseau Bitcoin uniquement après leur validité. Si une transaction est transmise au réseau avant le <code>nLocktime</code> spécifié, la transaction sera rejetée par le premier nœud comme invalide et ne sera pas relayée vers les autres nœuds. L&#8217;utilisation de <code>nLocktime</code> équivaut à postdater un chèque papier.</p>
</div>
<div class="sect4 data-line-272">
<h5 id="locktime_limitations">Limitations du temps de verrouillage des transactions</h5>
<div class="paragraph data-line-274">
<p>nLocktime a la limitation que s&#8217;il permet de dépenser certaines sorties dans le futur, il ne rend pas impossible de les dépenser jusqu&#8217;à ce moment-là. Expliquons cela avec l&#8217;exemple suivant.</p>
</div>
<div class="paragraph data-line-276">
<p>Alice signe une transaction en dépensant l&#8217;une de ses sorties à l&#8217;adresse de Bob, et fixe la transaction <code>nLocktime</code> à 3 mois dans le futur. Alice envoie cette transaction à Bob pour la conserver. Avec cette transaction, Alice et Bob savent que :</p>
</div>
<div class="ulist data-line-278">
<ul>
<li class="data-line-278">
<p>Bob ne peut pas transmettre la transaction pour racheter les fonds avant que 3 mois ne se soient écoulés.</p>
</li>
<li class="data-line-279">
<p>Bob peut transmettre la transaction après 3 mois.</p>
</li>
</ul>
</div>
<div class="paragraph data-line-281">
<p>Toutefois:</p>
</div>
<div class="ulist data-line-283">
<ul>
<li class="data-line-283">
<p>Alice peut créer une autre transaction, en dépensant deux fois les mêmes entrées sans temps de verrouillage. Ainsi, Alice peut passer le même UTXO avant que les 3 mois ne se soient écoulés.</p>
</li>
<li class="data-line-284">
<p>Bob n&#8217;a aucune garantie qu&#8217;Alice ne le fera pas.</p>
</li>
</ul>
</div>
<div class="paragraph data-line-286">
<p>Il est important de comprendre les limites de la transaction nLocktime. La seule garantie est que Bob ne pourra pas l&#8217;échanger avant que 3 mois ne se soient écoulés. Il n&#8217;y a aucune garantie que Bob obtiendra les fonds. Pour obtenir une telle garantie, la restriction de verrouillage temporel doit être placée sur l&#8217;UTXO lui-même et faire partie du script de verrouillage, plutôt que sur la transaction. Ceci est réalisé par la forme suivante de timelock, appelée Check Lock Time Verify.</p>
</div>
</div>
</div>
<div class="sect3 data-line-288">
<h4 id="_vérifier_lheure_de_verrouillage_cltv">Vérifier l&#8217;heure de verrouillage (CLTV)</h4>
<div class="paragraph data-line-290">
<p>En décembre 2015, une nouvelle forme de verrou temporel a été introduite dans le bitcoin en tant qu&#8217;embranchement convergent (soft fork) amélioré. Basé sur une spécification dans BIP-65, le nouvel opérateur de script appelé <em>CHECKLOCKTIMEVERIFY</em> (<em>CLTV</em>) a été ajouté au langage de script. <code>CLTV</code> et est un verrou temporel par sortie, plutôt qu&#8217;un verrou temporel par transaction comme c&#8217;est le cas avec nLocktime. Cela permet une plus grande flexibilité dans la manière dont les verrous temporels sont appliqués.</p>
</div>
<div class="paragraph data-line-292">
<p>En termes simples, en ajoutant l&#8217;opcode <code>CLTV</code> dans le script de rachat d&#8217;une sortie, cela restreint la sortie, de sorte qu&#8217;elle ne peut être dépensée qu&#8217;une fois le temps spécifié écoulé.</p>
</div>
<div class="admonitionblock tip data-line-295">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph data-line-296">
<p>Alors que <code>nLocktime</code> est un timelock au niveau de la transaction, <code>CLTV</code> est un timelock basé sur la sortie.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph data-line-299">
<p>CLTV ne remplace pas nLocktime, mais restreint plutôt des UTXO spécifiques de sorte qu&#8217;ils ne peuvent être dépensés que dans une future transaction avec <code>nLocktime</code> défini sur une valeur supérieure ou égale.</p>
</div>
<div class="paragraph data-line-301">
<p>L&#8217;opcode <code>CLTV</code> prend un paramètre en entrée, exprimé sous la forme d&#8217;un nombre au même format que <code>nLocktime</code> (soit une hauteur de bloc, soit un temps d&#8217;époque Unix). Comme indiqué par le suffixe VERIFY, <code>CLTV</code> est le type d&#8217;opcode qui arrête l&#8217;exécution du script si le résultat est FALSE. Si le résultat est TRUE, l&#8217;exécution continue.</p>
</div>
<div class="paragraph data-line-303">
<p>Pour verrouiller une sortie avec CLTV, vous l&#8217;insérez dans le script de rachat de la sortie dans la transaction qui crée la sortie. Par exemple, si Alice paie l&#8217;adresse de Bob, la sortie contiendra normalement un script P2PKH comme celui-ci :</p>
</div>
<div class="listingblock data-line-305">
<div class="content">
<pre>DUP HASH160 &lt;Hachage clé publique de Bob&gt; EQUALVERIFY CHECKSIG</pre>
</div>
</div>
<div class="paragraph data-line-309">
<p>Pour le verrouiller à un moment, disons dans 3 mois, la transaction serait une transaction P2SH avec un script de rachat comme celui-ci :</p>
</div>
<div class="listingblock data-line-311">
<div class="content">
<pre>&lt;now + 3 months&gt; CHECKLOCKTIMEVERIFY DROP DUP HASH160&lt;Bob's Public Key Hash&gt; EQUALVERIFIER CHECKSIG</pre>
</div>
</div>
<div class="paragraph data-line-315">
<p>où <code>&lt;now &#43; 3 months&gt;</code> est une hauteur de bloc ou une valeur temporelle estimée à 3 mois à partir du moment où la transaction est extraite : hauteur de bloc actuelle &#43; 12 960 (blocs) ou heure d&#8217;époque Unix actuelle &#43; 7 760 000 (secondes). Pour l&#8217;instant, ne vous inquiétez pas de l&#8217;opcode <code>DROP</code> qui suit CHECKLOCKTIMEVERIFY ; cela sera expliqué sous peu.</p>
</div>
<div class="paragraph data-line-317">
<p>Lorsque Bob essaie de dépenser cet UTXO, il construit une transaction qui fait référence à l&#8217;UTXO comme entrée. Il utilise sa signature et sa clé publique dans le script de déverrouillage de cette entrée et définit la transaction <code>nLocktime</code> pour qu&#8217;elle soit égale ou supérieure au verrouillage temporel dans l&#8217;ensemble <code>CHECKLOCKTIMEVERIFY</code> Alice. Bob diffuse ensuite la transaction sur le réseau Bitcoin.</p>
</div>
<div class="paragraph data-line-319">
<p>La transaction de Bob est évaluée comme suit. Si le paramètre <code>CHECKLOCKTIMEVERIFY</code> défini par Alice est inférieur ou égal au <code>nLocktime</code> de la transaction dépensière, l&#8217;exécution du script continue (agit comme si un opcode "no operation" ou NOP était exécuté). Sinon, l&#8217;exécution du script s&#8217;arrête et la transaction est considérée comme invalide.</p>
</div>
<div class="paragraph data-line-321">
<p>Plus précisément, <code>CHECKLOCKTIMEVERIFY</code> échoue et arrête l&#8217;exécution, marquant la transaction invalide si (source : BIP-65) :</p>
</div>
<div class="olist arabic data-line-323">
<ol class="arabic">
<li class="data-line-323">
<p>la pile est vide ; ou</p>
</li>
<li class="data-line-324">
<p>l&#8217;élément du haut de la pile est inférieur à 0 ; ou</p>
</li>
<li class="data-line-325">
<p>le type de verrou temporel (hauteur versus horodatage) de l&#8217;élément de la pile supérieure et le champ <code>nLocktime</code> ne sont pas les mêmes ; ou</p>
</li>
<li class="data-line-326">
<p>l&#8217;élément supérieur de la pile est supérieur au champ <code>nLocktime</code> de la transaction ; ou</p>
</li>
<li class="data-line-327">
<p>le champ <code>nSequence</code> de l&#8217;entrée est 0xffffffff.</p>
</li>
</ol>
</div>
<div class="admonitionblock note data-line-330">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph data-line-331">
<p>CLTV et <code>nLocktime</code> utilisent le même format pour décrire les verrous temporels, soit une hauteur de bloc, soit le temps écoulé en secondes depuis l&#8217;époque Unix. De manière critique, lorsqu&#8217;ils sont utilisés ensemble, le format de <code>nLocktime</code> doit correspondre à celui de <code>CLTV</code> dans les sorties - ils doivent tous deux référencer soit la hauteur de bloc, soit le temps en secondes.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph data-line-334">
<p>Après l&#8217;exécution, si <code>CLTV</code> est satisfait, le paramètre de temps qui l&#8217;a précédé reste l&#8217;élément supérieur de la pile et peut devoir être supprimé, avec DROP, pour une exécution correcte des opcodes de script suivants. Vous verrez souvent <code>CHECKLOCKTIMEVERIFY</code> suivi de <code>DROP</code> dans les scripts pour cette raison.</p>
</div>
<div class="paragraph data-line-336">
<p>En utilisant <code>nLocktime</code> conjointement avec CLTV, le scénario décrit dans <a href="#locktime_limitations">Limitations du temps de verrouillage des transactions</a> changements. Alice ne peut plus dépenser l&#8217;argent (car il est verrouillé avec la clé de Bob) et Bob ne peut pas le dépenser avant l&#8217;expiration du temps de verrouillage de 3 mois.</p>
</div>
<div class="paragraph data-line-338">
<p>En introduisant la fonctionnalité timelock directement dans le langage de script, <code>CLTV</code> nous permet de développer des scripts complexes très intéressants.</p>
</div>
<div class="paragraph data-line-340">
<p>La norme est définie dans <a href="https://github.com/bitcoin/bips/blob/master/bip-0065.mediawiki" data-href="https://github.com/bitcoin/bips/blob/master/bip-0065.mediawiki">BIP-65 (CHECKLOCKTIMEVERIFY)</a>.</p>
</div>
</div>
<div class="sect3 data-line-342">
<h4 id="_verrous_temporels_relatifs">Verrous temporels relatifs</h4>
<div class="paragraph data-line-344">
<p>nLocktime et <code>CLTV</code> sont les deux <em>verrous temporels absolus</em> en ce sens qu&#8217;ils spécifient un point absolu dans le temps. Les deux prochaines fonctionnalités de verrou temporel que nous examinerons sont des <em>verrous temporels relatifs</em> en ce sens qu&#8217;elles spécifient, comme condition de dépense d&#8217;une sortie, un temps écoulé depuis la confirmation de la sortie dans la chaîne de blocs.</p>
</div>
<div class="paragraph data-line-346">
<p>Les verrous temporels relatifs sont utiles car ils permettent de bloquer une chaîne de deux transactions interdépendantes ou plus, tout en imposant une contrainte de temps sur une transaction qui dépend du temps écoulé depuis la confirmation d&#8217;une transaction précédente. En d&#8217;autres termes, l&#8217;horloge ne commence pas à compter tant que l&#8217;UTXO n&#8217;est pas enregistré sur la chaîne de blocs. Cette fonctionnalité est particulièrement utile dans les canaux d&#8217;état bidirectionnels et les réseaux Lightning, comme nous le verrons dans <a href="#state_channels">[state_channels]</a>.</p>
</div>
<div class="paragraph data-line-348">
<p>Les verrous temporels relatifs, comme les verrous temporels absolus, sont implémentés à la fois avec une fonctionnalité au niveau de la transaction et un opcode au niveau du script. Le verrouillage temporel relatif au niveau de la transaction est implémenté comme une règle de consensus sur la valeur de nSequence, un champ de transaction qui est défini dans chaque entrée de transaction. Les verrous temporels relatifs au niveau du script sont implémentés avec l&#8217;opcode <code>CHECKSEQUENCEVERIFY</code> (CSV).</p>
</div>
<div class="paragraph data-line-350">
<p>Les verrous temporels relatifs sont implémentés conformément aux spécifications de <a href="https://github.com/bitcoin/bips/blob/master/bip-0068.mediawiki" data-href="https://github.com/bitcoin/bips/blob/master/bip-0068.mediawiki">BIP-68, Relative lock-time using consensus-enforced sequence numbers</a> et <a href="https://github.com/bitcoin/bips/blob/master/bip-0112.mediawiki" data-href="https://github.com/bitcoin/bips/blob/master/bip-0112.mediawiki">BIP-112, CHECKSEQUENCEVERIFY</a>.</p>
</div>
<div class="paragraph data-line-352">
<p>BIP-68 et BIP-112 ont été activés en mai 2016 en tant que mise à niveau soft fork des règles de consensus.</p>
</div>
</div>
<div class="sect3 data-line-354">
<h4 id="_verrous_temporels_relatifs_avec_nsequence">Verrous temporels relatifs avec nSequence</h4>
<div class="paragraph data-line-356">
<p>Des verrous temporels relatifs peuvent être définis sur chaque entrée d&#8217;une transaction, en définissant le champ <code>nSequence</code> dans chaque contribution.</p>
</div>
<div class="sect4 data-line-358">
<h5 id="_signification_originale_de_nsequence">Signification originale de nSequence</h5>
<div class="paragraph data-line-360">
<p>Le champ <code>nSequence</code> était à l&#8217;origine destiné (mais jamais correctement implémenté) à permettre la modification des transactions dans le mempool. Dans cette utilisation, une transaction contenant des entrées avec une valeur <code>nSequence</code> inférieure à 2<sup>32</sup> - 1 (0xFFFFFFFF) indiquait une transaction qui n&#8217;était pas encore "finalisée". Une telle transaction serait conservée dans le mempool jusqu&#8217;à ce qu&#8217;elle soit remplacée par une autre transaction dépensant les mêmes entrées avec une valeur <code>nSequence</code> plus élevée. Une fois qu&#8217;une transaction a été reçue dont les entrées avaient une valeur <code>nSequence</code> de 0xFFFFFFFF, elle serait considérée comme "finalisée" et minée.</p>
</div>
<div class="paragraph data-line-362">
<p>La signification originale de <code>nSequence</code> n&#8217;a jamais été correctement implémentée et la valeur de <code>nSequence</code> est habituellement définie sur 0xFFFFFFFF dans les transactions qui n&#8217;utilisent pas de verrous temporels. Pour les transactions avec <code>nLocktime</code> ou CHECKLOCKTIMEVERIFY, la valeur <code>nSequence</code> doit être inférieure à 2<sup>31</sup> pour que les gardes de verrou temporel aient un effet, comme expliqué ci-dessous.</p>
</div>
</div>
<div class="sect4 data-line-364">
<h5 id="_nsequence_comme_un_verrou_temporel_relatif_imposé_par_consensus">nSequence comme un verrou temporel relatif imposé par consensus</h5>
<div class="paragraph data-line-366">
<p>Depuis l&#8217;activation de BIP-68, de nouvelles règles de consensus s&#8217;appliquent pour toute transaction contenant une entrée dont la valeur <code>nSequence</code> est inférieure à 2<sup>31</sup> (le bit 1&lt;&lt;31 n&#8217;est pas défini). Par programmation, cela signifie que si le bit le plus significatif (bit 1&lt;&lt;31) n&#8217;est pas défini, c&#8217;est un indicateur qui signifie "temps de verrouillage relatif". Sinon (bit 1&lt;&lt;31 défini), la valeur <code>nSequence</code> est réservée à d&#8217;autres utilisations telles que l&#8217;activation de CHECKLOCKTIMEVERIFY, nLocktime, Opt-In-Replace-By-Fee et d&#8217;autres développements futurs.</p>
</div>
<div class="paragraph data-line-368">
<p>Les entrées de transaction avec des valeurs <code>nSequence</code> inférieures à 2<sup>31</sup> sont interprétées comme ayant un verrou temporel relatif. Une telle transaction n&#8217;est valide qu&#8217;une fois que l&#8217;entrée a vieilli du montant relatif du verrou temporel. Par exemple, une transaction avec une entrée et un verrou temporel relatif <code>nSequence</code> de 30 blocs n&#8217;est valide que lorsqu&#8217;au moins 30 blocs se sont écoulés depuis le moment où l&#8217;UTXO référencé dans l&#8217;entrée a été extrait. Étant donné que <code>nSequence</code> est un champ par entrée, une transaction peut contenir n&#8217;importe quel nombre d&#8217;entrées verrouillées dans le temps, qui doivent toutes avoir suffisamment vieilli pour que la transaction soit valide. Une transaction peut inclure à la fois des entrées à verrouillage temporel (nSequence &lt; 2<sup>31</sup>) et des entrées sans verrouillage temporel relatif (nSequence &gt;= 2<sup>31</sup>).</p>
</div>
<div class="paragraph data-line-370">
<p>La valeur <code>nSequence</code> est spécifiée en blocs ou en secondes, mais dans un format légèrement différent de celui que nous avons vu utilisé dans nLocktime. Un indicateur de type est utilisé pour différencier les valeurs comptant les blocs et les valeurs comptant le temps en secondes. Le drapeau de type est défini dans le 23e bit le moins significatif (c&#8217;est-à-dire la valeur 1&lt;&lt;22). Si le type-flag est défini, alors la valeur <code>nSequence</code> est interprétée comme un multiple de 512 secondes. Si le drapeau de type n&#8217;est pas défini, la valeur <code>nSequence</code> est interprétée comme un nombre de blocs.</p>
</div>
<div class="paragraph data-line-372">
<p>Lors de l&#8217;interprétation de <code>nSequence</code> comme un timelock relatif, seuls les 16 bits les moins significatifs sont pris en compte. Une fois que les drapeaux (bits 32 et 23) sont évalués, la valeur <code>nSequence</code> est généralement "masquée" avec un masque de 16 bits (par exemple, <code>nSequence</code> &amp; 0x0000FFFF).</p>
</div>
<div class="paragraph data-line-374">
<p><a href="#bip_68_def_of_nseq">Définition BIP-68 du codage nSequence (Source : BIP-68)</a> montre la disposition binaire de la valeur nSequence, telle que définie par BIP-68.</p>
</div>
<div id="bip_68_def_of_nseq" class="imageblock data-line-378">
<div class="content">
<img src="images/mbc2_0701.png" alt="Définition BIP-68 du codage nSequence">
</div>
<div class="title">Figure 1. Définition BIP-68 du codage nSequence (Source : BIP-68)</div>
</div>
<div class="paragraph data-line-381">
<p>Les verrous temporels relatifs basés sur l&#8217;application consensuelle de la valeur <code>nSequence</code> sont définis dans BIP-68.</p>
</div>
<div class="paragraph data-line-383">
<p>La norme est définie dans <a href="https://github.com/bitcoin/bips/blob/master/bip-0068.mediawiki" data-href="https://github.com/bitcoin/bips/blob/master/bip-0068.mediawiki">BIP-68, Relative lock-time using consensus-enforced sequence numbers</a>.</p>
</div>
</div>
</div>
<div class="sect3 data-line-385">
<h4 id="_verrous_temporels_relatifs_avec_csv">Verrous temporels relatifs avec CSV</h4>
<div class="paragraph data-line-387">
<p>Tout comme CLTV et nLocktime, il existe un opcode de script pour les verrous temporels relatifs qui exploite le Valeur <code>nSequence</code> dans les scripts. Cet opcode est CHECKSEQUENCEVERIFY, communément appelé <code>CSV</code> en abrégé.</p>
</div>
<div class="paragraph data-line-389">
<p>L&#8217;opcode CSV, lorsqu&#8217;il est évalué dans le script de remboursement d&#8217;un UTXO, permet de dépenser uniquement dans une transaction dont la valeur d&#8217;entrée <code>nSequence</code> est supérieure ou égale au paramètre CSV. Essentiellement, cela limite la dépense de l&#8217;UTXO jusqu&#8217;à ce qu&#8217;un certain nombre de blocs ou de secondes se soient écoulés par rapport au moment où l&#8217;UTXO a été miné.</p>
</div>
<div class="paragraph data-line-391">
<p>Comme pour CLTV, la valeur dans <code>CSV</code> doit correspondre au format de la valeur <code>nSequence</code> correspondante. Si <code>CSV</code> est spécifié en termes de blocs, il doit en être de même pour nSequence. Si <code>CSV</code> est spécifié en termes de secondes, alors <code>nSequence</code> doit également l&#8217;être.</p>
</div>
<div class="paragraph data-line-393">
<p>Les timelocks relatifs avec <code>CSV</code> sont particulièrement utiles lorsque plusieurs transactions (chaînées) sont créées et signées, mais non propagées, lorsqu&#8217;elles sont conservées "hors chaîne". Une transaction enfant ne peut pas être utilisée tant que la transaction parent n&#8217;a pas été propagée, extraite et vieillie au moment spécifié dans le timelock relatif. Une application de ce cas d&#8217;utilisation peut être vue dans <a href="#state_channels">[state_channels]</a> et <a href="#lightning_network">[lightning_network]</a>.</p>
</div>
<div class="paragraph data-line-395">
<p>CSV est défini en détail dans <a href="https://github.com/bitcoin/bips/blob/master/bip-0112.mediawiki" data-href="https://github.com/bitcoin/bips/blob/master/bip-0112.mediawiki">BIP-112, CHECKSEQUENCEVERIFY</a>.</p>
</div>
</div>
<div class="sect3 data-line-398">
<h4 id="_temps_médian_passé">Temps médian passé</h4>
<div class="paragraph data-line-400">
<p>Dans le cadre de l&#8217;activation des verrous temporels relatifs, il y a également eu un changement dans la façon dont le "temps" est calculé pour les verrous temporels (à la fois absolus et relatifs). Dans le bitcoin, il existe une différence subtile, mais très significative, entre le temps du mur et le temps du consensus. Bitcoin est un réseau décentralisé, ce qui signifie que chaque participant a sa propre vision du temps. Les événements sur le réseau ne se produisent pas instantanément partout. La latence du réseau doit être prise en compte dans la perspective de chaque nœud. Finalement, tout est synchronisé pour créer un grand livre commun. Bitcoin atteint un consensus toutes les 10 minutes sur l&#8217;état du grand livre tel qu&#8217;il existait dans le passé.</p>
</div>
<div class="paragraph data-line-402">
<p>Les horodatages définis dans les en-têtes de bloc sont définis par les mineurs. Il existe un certain degré de latitude autorisé par les règles de consensus pour tenir compte des différences de précision d&#8217;horloge entre les nœuds décentralisés. Cependant, cela crée une incitation malheureuse pour les mineurs à mentir sur le temps passé dans un bloc afin de gagner des frais supplémentaires en incluant des transactions verrouillées dans le temps qui ne sont pas encore matures. Voir la section suivante pour plus d&#8217;informations.</p>
</div>
<div class="paragraph data-line-404">
<p>Pour supprimer l&#8217;incitation au mensonge et renforcer la sécurité des verrous temporels, un BIP a été proposé et activé en même temps que les BIP des verrous temporels relatifs. Il s&#8217;agit de BIP-113, qui définit une nouvelle mesure consensuelle du temps appelée <em>Median-Time-Past</em> (temps-médian-passé).</p>
</div>
<div class="paragraph data-line-406">
<p>Le Median-Time-Past est calculé en prenant les horodatages des 11 derniers blocs et en trouvant la médiane. Ce temps médian devient alors le temps de consensus et est utilisé pour tous les calculs de verrou temporel. En prenant le point médian d&#8217;environ deux heures dans le passé, l&#8217;influence de l&#8217;horodatage de n&#8217;importe quel bloc est réduite. En incorporant 11 blocs, aucun mineur ne peut influencer les horodatages afin de gagner des frais sur les transactions avec un verrou temporel qui n&#8217;est pas encore arrivé à échéance.</p>
</div>
<div class="paragraph data-line-408">
<p>Median-Time-Past modifie l&#8217;implémentation des calculs de temps pour nLocktime, CLTV, <code>nSequence</code> et CSV. L&#8217;heure de consensus calculée par Median-Time-Past est toujours d&#8217;environ une heure en retard sur l&#8217;heure de l&#8217;horloge murale. Si vous créez des transactions avec verrou temporel, vous devez en tenir compte lors de l&#8217;estimation de la valeur souhaitée à encoder dans nLocktime, nSequence, <code>CLTV</code> et CSV.</p>
</div>
<div class="paragraph data-line-410">
<p>Median-Time-Past est spécifié dans <a href="https://github.com/bitcoin/bips/blob/master/bip-0113.mediawiki" data-href="https://github.com/bitcoin/bips/blob/master/bip-0113.mediawiki">BIP-113</a>.</p>
</div>
</div>
<div class="sect3 data-line-413">
<h4 id="fee_sniping">Défense contre le "sniping" avec un verrou temporel</h4>
<div class="paragraph data-line-415">
<p>Le "sniping" ou le "ciblage" est un scénario d&#8217;attaque théorique, où les mineurs tentant de réécrire des blocs passés "snipe" ou "en ciblant" des frais plus élevés transactions des futurs blocs pour maximiser leur rentabilité.</p>
</div>
<div class="paragraph data-line-417">
<p>Par exemple, disons que le bloc le plus élevé existant est le bloc #100 000. Si au lieu d&#8217;essayer d&#8217;exploiter le bloc #100 001 pour étendre la chaîne, certains mineurs tentent de réexploiter #100 000. Ces mineurs peuvent choisir d&#8217;inclure toute transaction valide (qui n&#8217;a pas encore été exploitée) dans leur bloc candidat #100 000. Ils n&#8217;ont pas à reminer le bloc avec les mêmes transactions. En fait, ils sont incités à sélectionner les transactions les plus rentables (frais les plus élevés par Ko) à inclure dans leur bloc. Ils peuvent inclure toutes les transactions qui se trouvaient dans "l&#8217;ancien" bloc #100 000, ainsi que toutes les transactions du mempool actuel. Essentiellement, ils ont la possibilité d&#8217;extraire des transactions du "présent" vers le "passé" réécrit lorsqu&#8217;ils recréent le bloc #100 000.</p>
</div>
<div class="paragraph data-line-419">
<p>Aujourd&#8217;hui, cette attaque n&#8217;est pas très lucrative, car la récompense de bloc est bien supérieure au total des frais par bloc. Mais à un moment donné dans le futur, les frais de transaction représenteront la majorité de la récompense minière (ou même l&#8217;intégralité de la récompense minière). A ce moment-là, ce scénario devient inévitable.</p>
</div>
<div class="paragraph data-line-421">
<p>Pour éviter le "ciblage de frais", lorsque Bitcoin Core crée des transactions, il utilise <code>nLocktime</code> pour les limiter au "bloc suivant", par défaut. Dans notre scénario, Bitcoin Core définirait <code>nLocktime</code> sur 100 001 sur toute transaction créée. Dans des circonstances normales, ce <code>nLocktime</code> n&#8217;a aucun effet - les transactions ne peuvent être incluses que dans le bloc #100 001 de toute façon ; c&#8217;est le bloc suivant.</p>
</div>
<div class="paragraph data-line-423">
<p>Mais dans le cadre d&#8217;une attaque enfourchement de la chaîne de blocs/double dépense, les mineurs ne seraient pas en mesure d&#8217;extraire des transactions à frais élevés du mempool, car toutes ces transactions seraient bloquées dans le temps pour bloquer #100 001. Ils ne peuvent reminer que #100 000 avec les transactions valides à ce moment-là, ne gagnant essentiellement aucun nouveau frais.</p>
</div>
<div class="paragraph data-line-425">
<p>Pour ce faire, Bitcoin Core définit le <code>nLocktime</code> sur toutes les nouvelles transactions à &lt;current block # + 1&gt; et définit la <code>nSequence</code> sur toutes les entrées à 0xFFFFFFFE pour activer nLocktime.</p>
</div>
</div>
</div>
<div class="sect2 data-line-427">
<h3 id="_scripts_avec_contrôle_de_flux_clauses_conditionnelles">Scripts avec contrôle de flux (clauses conditionnelles)</h3>
<div class="paragraph data-line-429">
<p>L&#8217;une des fonctionnalités les plus puissantes de Bitcoin Script est le contrôle de flux, également connu sous le nom de clauses conditionnelles. Vous êtes probablement familiarisé avec le contrôle de flux dans divers langages de programmation qui utilisent la construction IF...THEN...ELSE. Les clauses conditionnelles Bitcoin semblent un peu différentes, mais sont essentiellement la même construction.</p>
</div>
<div class="paragraph data-line-431">
<p>À un niveau de base, les opcodes conditionnels bitcoin nous permettent de construire un script de rachat qui a deux façons d&#8217;être déverrouillé, en fonction d&#8217;un résultat TRUE/FALSE d&#8217;évaluation d&#8217;une condition logique. Par exemple, si x est TRUE, le script de rachat est A et le script de rachat ELSE est B.</p>
</div>
<div class="paragraph data-line-433">
<p>De plus, les expressions conditionnelles Bitcoin peuvent être "imbriquées" indéfiniment, ce qui signifie qu&#8217;une clause conditionnelle peut en contenir une autre, qui en contient une autre, etc. Le contrôle de flux Bitcoin Script peut être utilisé pour construire des scripts très complexes avec des centaines voire des milliers de chemins d&#8217;exécution possibles. Il n&#8217;y a pas de limite à l&#8217;imbrication, mais les règles de consensus imposent une limite à la taille maximale, en octets, d&#8217;un script.</p>
</div>
<div class="paragraph data-line-435">
<p>Bitcoin implémente le contrôle de flux à l&#8217;aide des opcodes IF, ELSE, <code>ENDIF</code> et NOTIF. De plus, les expressions conditionnelles peuvent contenir des opérateurs booléens tels que BOOLAND, <code>BOOLOR</code> et NOT.</p>
</div>
<div class="paragraph data-line-437">
<p>À première vue, vous pouvez trouver les scripts de contrôle de flux du bitcoin déroutants. En effet, Bitcoin Script est un langage de pile. De la même manière que <code>1 &#43; 1</code> semble "renversé" lorsqu&#8217;il est exprimé comme 1 1 ADD, les clauses de contrôle de flux dans bitcoin semblent également "renversés".</p>
</div>
<div class="paragraph data-line-439">
<p>Dans la plupart des langages de programmation traditionnels (procéduraux), le contrôle de flux ressemble à ceci :</p>
</div>
<div class="listingblock data-line-442">
<div class="title">Pseudocode de contrôle de flux dans la plupart des langages de programmation</div>
<div class="content">
<pre>si (condition):
  code à exécuter lorsque la condition est vraie
autre:
  code à exécuter lorsque la condition est fausse
code à exécuter dans les deux cas</pre>
</div>
</div>
<div class="paragraph data-line-450">
<p>Dans un langage basé sur la pile comme Bitcoin Script, la condition logique vient avant le IF, ce qui le fait apparaître "en arrière", comme ceci :</p>
</div>
<div class="listingblock data-line-453">
<div class="title">Contrôle de flux Bitcoin Script</div>
<div class="content">
<pre>condition
IF
  code à exécuter lorsque la condition est vraie
ELSE
  code à exécuter lorsque la condition est fausse
ENDIF
code à exécuter dans les deux cas</pre>
</div>
</div>
<div class="paragraph data-line-463">
<p>Lors de la lecture du script Bitcoin, rappelez-vous que la condition évaluée vient <em>avant</em> l&#8217;opcode IF.</p>
</div>
<div class="sect3 data-line-465">
<h4 id="_clauses_conditionnelles_avec_les_opcodes_verify">Clauses conditionnelles avec les opcodes VERIFY</h4>
<div class="paragraph data-line-467">
<p>Une autre forme de conditionnel dans Bitcoin Script est tout opcode qui se termine par VERIFY. Le suffixe <code>VERIFY</code> signifie que si la condition évaluée n&#8217;est pas TRUE, l&#8217;exécution du script se termine immédiatement et la transaction est considérée comme invalide.</p>
</div>
<div class="paragraph data-line-469">
<p>Contrairement à une clause IF, qui offre des chemins d&#8217;exécution alternatifs, le suffixe <code>VERIFY</code> agit comme une <em>clause de garde</em>, ne continuant que si une condition préalable est remplie.</p>
</div>
<div class="paragraph data-line-471">
<p>Par exemple, le script suivant nécessite la signature de Bob et une pré-image (secret) qui produit un hachage spécifique. Les deux conditions doivent être remplies pour le déverrouiller :</p>
</div>
<div class="listingblock data-line-474">
<div class="title">Un script de rachat avec une clause de garde EQUALVERIFY.</div>
<div class="content">
<pre>HASH160 &lt;expected hash&gt; EQUALVERIFY &lt;Bob's Pubkey&gt; CHECKSIG</pre>
</div>
</div>
<div class="paragraph data-line-478">
<p>Pour racheter cela, Bob doit construire un script de déverrouillage qui présente une pré-image valide et une signature :</p>
</div>
<div class="listingblock data-line-481">
<div class="title">Un script de déverrouillage pour satisfaire le script de rachat ci-dessus</div>
<div class="content">
<pre>&lt;Bob's Sig&gt; &lt;hash pre-image&gt;</pre>
</div>
</div>
<div class="paragraph data-line-485">
<p>Sans présenter la pré-image, Bob ne peut pas accéder à la partie du script qui vérifie sa signature.</p>
</div>
<div class="paragraph pagebreak-after data-line-488">
<p>Ce script peut être écrit avec un <code>IF</code> à la place :</p>
</div>
<div class="listingblock data-line-491">
<div class="title">Un script de rachat avec une clause de garde IF</div>
<div class="content">
<pre>HASH160 &lt;expected hash&gt; EQUAL
IF
   &lt;Bob's Pubkey&gt; CHECKSIG
ENDIF</pre>
</div>
</div>
<div class="paragraph data-line-498">
<p>Le script de déverrouillage de Bob est identique :</p>
</div>
<div class="listingblock data-line-501">
<div class="title">Un script de déverrouillage pour satisfaire le script de rachat ci-dessus</div>
<div class="content">
<pre>&lt;Bob's Sig&gt; &lt;hash pre-image&gt;</pre>
</div>
</div>
<div class="paragraph data-line-505">
<p>Le script avec <code>IF</code> fait la même chose que d&#8217;utiliser un opcode avec un suffixe <code>VERIFY</code> ; elles fonctionnent toutes deux comme des clauses de garde. Cependant, la construction <code>VERIFY</code> est plus efficace, utilisant deux opcodes de moins.</p>
</div>
<div class="paragraph data-line-507">
<p>Alors, quand utilisons-nous <code>VERIFY</code> et quand utilisons-nous IF ? Si tout ce que nous essayons de faire est d&#8217;attacher une condition préalable (clause de garde), alors <code>VERIFY</code> est préférable. Si, toutefois, nous voulons avoir plus d&#8217;un chemin d&#8217;exécution (contrôle de flux), nous avons besoin d&#8217;une clause de contrôle de flux IF...ELSE.</p>
</div>
<div class="admonitionblock tip data-line-510">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph data-line-511">
<p>Un opcode tel que <code>EQUAL</code> poussera le résultat (TRUE/FALSE) sur la pile, le laissant là pour évaluation par les opcodes suivants. En revanche, le suffixe de l&#8217;opcode <code>EQUALVERIFY</code> ne laisse rien sur la pile. Les opcodes qui se terminent par <code>VERIFY</code> ne laissent pas le résultat sur la pile.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3 data-line-514">
<h4 id="_utilisation_du_contrôle_de_flux_dans_les_scripts">Utilisation du contrôle de flux dans les scripts</h4>
<div class="paragraph data-line-516">
<p>Une utilisation très courante du contrôle de flux dans Bitcoin Script consiste à construire un script de rachat qui offre plusieurs chemins d&#8217;exécution, chacun une manière différente de racheter l&#8217;UTXO.</p>
</div>
<div class="paragraph data-line-518">
<p>Regardons un exemple simple, où nous avons deux signataires, Alice et Bob, et l&#8217;un ou l&#8217;autre est en mesure de racheter. Avec multisig, cela serait exprimé sous la forme d&#8217;un script multisig 1 sur 2. Pour des raisons de démonstration, nous ferons la même chose avec une clause IF :</p>
</div>
<div class="listingblock data-line-520">
<div class="content">
<pre>IF
 &lt;Alice's Pubkey&gt; CHECKSIG
ELSE
 &lt;Bob's Pubkey&gt; CHECKSIG
ENDIF</pre>
</div>
</div>
<div class="paragraph data-line-528">
<p>En regardant ce script de rachat, vous vous demandez peut-être : "Où est la condition ? Il n&#8217;y a rien qui précède la clause <code>IF</code> !"</p>
</div>
<div class="paragraph data-line-530">
<p>La condition ne fait pas partie du script de rachat. Au lieu de cela, la condition sera proposée dans le script de déverrouillage, permettant à Alice et Bob de "choisir" le chemin d&#8217;exécution qu&#8217;ils souhaitent.</p>
</div>
<div class="paragraph data-line-532">
<p>Alice rachète cela avec le script de déverrouillage :</p>
</div>
<div class="listingblock data-line-533">
<div class="content">
<pre>&lt;Alice's Sig&gt; 1</pre>
</div>
</div>
<div class="paragraph data-line-537">
<p>Le <code>1</code> à la fin sert de condition (TRUE) qui fera que la clause <code>IF</code> exécutera le premier chemin de rachat pour lequel Alice a une signature.</p>
</div>
<div class="paragraph data-line-539">
<p>Pour que Bob puisse racheter cela, il devrait choisir le deuxième chemin d&#8217;exécution en donnant une valeur <code>FALSE</code> à la clause IF :</p>
</div>
<div class="listingblock data-line-541">
<div class="content">
<pre>&lt;Bob's Sig&gt; 0</pre>
</div>
</div>
<div class="paragraph data-line-545">
<p>Le script de déverrouillage de Bob place un <code>0</code> sur la pile, ce qui oblige la clause <code>IF</code> à exécuter le deuxième script (ELSE), qui nécessite la signature de Bob.</p>
</div>
<div class="paragraph data-line-547">
<p>Puisque les clauses <code>IF</code> peuvent être imbriquées, nous pouvons créer un "labyrinthe" de chemins d&#8217;exécution. Le script de déverrouillage peut fournir une "carte" sélectionnant le chemin d&#8217;exécution réellement exécuté :</p>
</div>
<div class="listingblock data-line-549">
<div class="content">
<pre>IF
  script A
ELSE
  IF
    script B
  ELSE
    script C
  ENDIF
ENDIF</pre>
</div>
</div>
<div class="paragraph data-line-561">
<p>Dans ce scénario, il existe trois chemins d&#8217;exécution (script A, <code>script B</code> et script C). Le script de déverrouillage fournit un chemin sous la forme d&#8217;une séquence de valeurs <code>TRUE</code> ou FALSE. Pour sélectionner le chemin script B, par exemple, le script de déverrouillage doit se terminer par <code>1 0</code> (TRUE, FALSE). Ces valeurs seront poussées sur la pile, de sorte que la deuxième valeur (FALSE) se retrouve en haut de la pile. La clause <code>IF</code> externe extrait la valeur <code>FALSE</code> et exécute la première clause ELSE. Ensuite, la valeur <code>TRUE</code> se déplace vers le haut de la pile et est évaluée par le <code>IF</code> interne (imbriqué), en sélectionnant le chemin d&#8217;exécution B.</p>
</div>
<div class="paragraph data-line-563">
<p>En utilisant cette construction, nous pouvons créer des scripts de rachat avec des dizaines ou des centaines de chemins d&#8217;exécution, chacun offrant une manière différente de racheter l&#8217;UTXO. Pour dépenser, nous construisons un script de déverrouillage qui navigue dans le chemin d&#8217;exécution en plaçant les valeurs <code>TRUE</code> et <code>FALSE</code> appropriées sur la pile à chaque point de contrôle de flux.</p>
</div>
</div>
</div>
<div class="sect2 data-line-565">
<h3 id="_exemple_de_script_complexe">Exemple de script complexe</h3>
<div class="paragraph data-line-567">
<p>Dans cette section, nous combinons de nombreux concepts de ce chapitre en un seul exemple.</p>
</div>
<div class="paragraph data-line-569">
<p>Notre exemple utilise l&#8217;histoire de Mohammed, le propriétaire d&#8217;une entreprise à Dubaï qui exploite une entreprise d&#8217;import/export.</p>
</div>
<div class="paragraph data-line-571">
<p>Dans cet exemple, Mohammed souhaite construire un compte de capital d&#8217;entreprise avec des règles flexibles. Le schéma qu&#8217;il crée nécessite différents niveaux d&#8217;autorisation en fonction des verrous temporels. Les participants au programme multisig sont Mohammed, ses deux partenaires Saeed et Zaira, et leur avocat Abdul. Les trois partenaires prennent des décisions basées sur une règle de majorité, donc deux des trois doivent être d&#8217;accord. Cependant, en cas de problème avec leurs clés, ils souhaitent que leur avocat puisse récupérer les fonds avec l&#8217;une des trois signatures d&#8217;associés. Enfin, si tous les associés sont indisponibles ou inaptes pendant un certain temps, ils souhaitent que l&#8217;avocat puisse gérer directement le compte.</p>
</div>
<div class="paragraph data-line-573">
<p>Voici le script de rachat que Mohammed conçoit pour y parvenir (préfixe de numéro de ligne en tant que XX) :</p>
</div>
<div class="listingblock data-line-576">
<div class="title">Variable Multi-Signature avec verrou temporel</div>
<div class="content">
<pre>01  IF
02    IF
03      2
04    ELSE
05      &lt;30 days&gt; CHECKSEQUENCEVERIFY DROP
06      &lt;Abdul the Lawyer's Pubkey&gt; CHECKSIGVERIFY
07      1
08    ENDIF
09    &lt;Mohammed's Pubkey&gt; &lt;Saeed's Pubkey&gt; &lt;Zaira's Pubkey&gt; 3 CHECKMULTISIG
10  ELSE
11    &lt;90 days&gt; CHECKSEQUENCEVERIFY DROP
12    &lt;Abdul the Lawyer's Pubkey&gt; CHECKSIG
13  ENDIF</pre>
</div>
</div>
<div class="paragraph data-line-592">
<p>Le script de Mohammed implémente trois chemins d&#8217;exécution à l&#8217;aide de clauses de contrôle de flux imbriquées IF...ELSE.</p>
</div>
<div class="paragraph data-line-594">
<p>Dans le premier chemin d&#8217;exécution, ce script fonctionne comme un simple multisig 2 sur 3 avec les trois partenaires. Ce chemin d&#8217;exécution se compose des lignes 3 et 9. La ligne 3 définit le quorum du multisig à <code>2</code> (2-de-3). Ce chemin d&#8217;exécution peut être sélectionné en mettant <code>TRUE TRUE</code> à la fin du script de déverrouillage :</p>
</div>
<div class="listingblock data-line-597">
<div class="title">Script de déverrouillage pour le premier chemin d&#8217;exécution (2-de-3 multisig)</div>
<div class="content">
<pre>0 &lt;Mohammed's Sig&gt; &lt;Zaira's Sig&gt; TRUE TRUE</pre>
</div>
</div>
<div class="admonitionblock tip data-line-603">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph data-line-604">
<p>Le <code>0</code> au début de ce script de déverrouillage est dû à un bogue dans <code>CHECKMULTISIG</code> qui extrait une valeur supplémentaire de la pile. La valeur supplémentaire est ignorée par le CHECKMULTISIG, mais elle doit être présente ou le script échoue. Pousser <code>0</code> (habituellement) est une solution de contournement au bogue, comme décrit dans <a href="#multisig_bug">Un bogue dans l&#8217;exécution de CHECKMULTISIG</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph data-line-607">
<p>Le deuxième chemin d&#8217;exécution ne peut être utilisé qu&#8217;après 30 jours à compter de la création de l&#8217;UTXO. À ce moment-là, il faut la signature d&#8217;Abdul l&#8217;avocat et de l&#8217;un des trois partenaires (un multisig 1 sur 3). Ceci est réalisé par la ligne 7, qui fixe le quorum pour le multisig à 1. Pour sélectionner ce chemin d&#8217;exécution, le script de déverrouillage se terminerait par FALSE TRUE :</p>
</div>
<div class="listingblock data-line-610">
<div class="title">Script de déverrouillage pour le deuxième chemin d&#8217;exécution (Avocat + 1 sur 3)</div>
<div class="content">
<pre>0 &lt;Abdul the Lawyer's Sig&gt; &lt;Saeed's Sig&gt; FALSE TRUE</pre>
</div>
</div>
<div class="admonitionblock tip data-line-615">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph data-line-616">
<p>Pourquoi FAUX VRAI ? N&#8217;est-ce pas à l&#8217;envers ? Parce que les deux valeurs sont poussées sur la pile, avec <code>FALSE</code> poussé en premier, puis <code>TRUE</code> poussé en second. <code>TRUE</code> est donc dépilé <em>premier</em> par le premier opcode IF.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph data-line-619">
<p>Enfin, la troisième voie d&#8217;exécution permet à Abdul l&#8217;avocat de dépenser les fonds seul, mais seulement après 90 jours. Pour sélectionner ce chemin d&#8217;exécution, le script de déverrouillage doit se terminer par FALSE :</p>
</div>
<div class="listingblock data-line-622">
<div class="title">Script de déverrouillage pour le troisième chemin d&#8217;exécution (avocat uniquement)</div>
<div class="content">
<pre>&lt;Abdul the Lawyer's Sig&gt; FALSE</pre>
</div>
</div>
<div class="paragraph data-line-626">
<p>Essayez d&#8217;exécuter le script sur papier pour voir comment il se comporte sur la pile.</p>
</div>
<div class="paragraph data-line-628">
<p>Quelques éléments supplémentaires à prendre en compte lors de la lecture de cet exemple. Voyez si vous pouvez trouver les réponses :</p>
</div>
<div class="ulist data-line-630">
<ul>
<li class="data-line-630">
<p>Pourquoi l&#8217;avocat ne peut-il pas racheter le troisième chemin d&#8217;exécution à tout moment en le sélectionnant avec <code>FALSE</code> sur le script de déverrouillage ?</p>
</li>
<li class="data-line-632">
<p>Combien de chemins d&#8217;exécution peuvent être utilisés 5, 35 et 105 jours, respectivement, après le minage de l&#8217;UTXO ?</p>
</li>
<li class="data-line-634">
<p>Les fonds sont-ils perdus si l&#8217;avocat perd sa clé ? Votre réponse change-t-elle si 91 jours se sont écoulés ?</p>
</li>
<li class="data-line-636">
<p>Comment les associés « remettent-ils à zéro » l&#8217;horloge tous les 29 ou 89 jours pour empêcher l&#8217;avocat d&#8217;accéder aux fonds ?</p>
</li>
<li class="data-line-638">
<p>Pourquoi certains opcodes <code>CHECKSIG</code> dans ce script ont-ils le suffixe <code>VERIFY</code> alors que d&#8217;autres non ?</p>
</li>
</ul>
</div>
</div>
<div class="sect2 data-line-641">
<h3 id="segwit">Témoin séparé</h3>
<div class="paragraph data-line-643">
<p>Le Segregated Witness (segwit) ou le "témoin séparé" est une mise à niveau des règles de consensus bitcoin et du protocole réseau, proposée et mise en œuvre en tant que embranchement convergent BIP-9 qui a été activé sur le réseau principal de bitcoin le 1er août 2017.</p>
</div>
<div class="paragraph data-line-645">
<p>En cryptographie, le terme « témoin » est utilisé pour décrire une solution à un puzzle cryptographique. En termes de bitcoin, le témoin satisfait une condition cryptographique placée sur une sortie de transaction non dépensée (UTXO).</p>
</div>
<div class="paragraph data-line-647">
<p>Dans le contexte du bitcoin, une signature numérique est <em>un type de témoin</em>, mais un témoin est plus largement toute solution qui peut satisfaire les conditions imposées à un UTXO et débloquer cet UTXO pour les dépenses. Le terme "témoin" est un terme plus général pour un "script de déverrouillage" ou "scriptSig".</p>
</div>
<div class="paragraph data-line-649">
<p>Avant l&#8217;introduction de segwit, chaque entrée d&#8217;une transaction était suivie des données témoins qui la déverrouillaient. Les données témoins ont été intégrées à la transaction dans le cadre de chaque entrée. Le terme <em>témoin séparé</em>, ou <em>segwit</em> en abrégé, signifie simplement séparer la signature ou le script de déverrouillage d&#8217;une sortie spécifique. Pensez "scriptSig séparé" ou "signature séparée" dans sa forme la plus simple.</p>
</div>
<div class="paragraph data-line-651">
<p>Le témoin séparé (Segregated Witness) est donc une modification architecturale du bitcoin qui vise à déplacer les données témoins du champ <code>scriptSig</code> (script de déverrouillage) d&#8217;une transaction vers une structure de données <em>témoin</em> distincte qui accompagne une transaction. Les clients peuvent demander des données de transaction avec ou sans les données de témoin qui les accompagnent.</p>
</div>
<div class="paragraph data-line-653">
<p>Dans cette section, nous examinerons certains des avantages du témoin séparé, décrirons le mécanisme utilisé pour déployer et mettre en œuvre ce changement d&#8217;architecture et démontrerons l&#8217;utilisation du témoin séparé dans les transactions et les adresses.</p>
</div>
<div class="paragraph data-line-655">
<p>Le témoin séparé est défini par les BIP suivants :</p>
</div>
<div class="dlist data-line-657">
<dl>
<dt class="hdlist1"><a href="https://github.com/bitcoin/bips/blob/master/bip-0141.mediawiki" data-href="https://github.com/bitcoin/bips/blob/master/bip-0141.mediawiki">BIP-141</a> </dt>
<dd>
<p>La principale définition du témoin séparé.</p>
</dd>
<dt class="hdlist1"><a href="https://github.com/bitcoin/bips/blob/master/bip-0143.mediawiki" data-href="https://github.com/bitcoin/bips/blob/master/bip-0143.mediawiki">BIP-143</a> </dt>
<dd>
<p>Vérification de la signature des transactions pour le programme témoin de la version 0</p>
</dd>
<dt class="hdlist1"><a href="https://github.com/bitcoin/bips/blob/master/bip-0144.mediawiki" data-href="https://github.com/bitcoin/bips/blob/master/bip-0144.mediawiki">BIP-144</a> </dt>
<dd>
<p>Services à pair; Nouveaux messages réseau et formats de sérialisation</p>
</dd>
<dt class="hdlist1"><a href="https://github.com/bitcoin/bips/blob/master/bip-0145.mediawiki" data-href="https://github.com/bitcoin/bips/blob/master/bip-0145.mediawiki">BIP-145</a> </dt>
<dd>
<p>Mises à jour de getblocktemplate pour le témoin séparé Segregated Witness (pour minage)</p>
</dd>
<dt class="hdlist1"><a href="https://github.com/bitcoin/bips/blob/master/bip-0173.mediawiki" data-href="https://github.com/bitcoin/bips/blob/master/bip-0173.mediawiki">BIP-173</a> </dt>
<dd>
<p>Format d&#8217;adresse Base32 pour les sorties témoins natives v0-16</p>
</dd>
</dl>
</div>
<div class="sect3 data-line-668">
<h4 id="_pourquoi_un_témoin_séparé">Pourquoi un témoin séparé ?</h4>
<div class="paragraph data-line-670">
<p>Le témoin séparé est un changement architectural qui a plusieurs effets sur l&#8217;évolutivité, la sécurité, les incitations économiques et les performances du bitcoin :</p>
</div>
<div class="dlist data-line-672">
<dl>
<dt class="hdlist1">Malléabilité de transaction </dt>
<dd>
<p>En déplaçant le témoin en dehors des données de transaction, le hachage de transaction utilisé comme identifiant n&#8217;inclut plus les données de témoin. Étant donné que les données témoins sont la seule partie de la transaction qui peut être modifiée par un tiers (voir <a href="#segwit_txid">Identifiants de transaction</a>), sa suppression supprime également la possibilité d&#8217;attaques de malléabilité des transactions. Avec le témoin séparé, les hachages de transaction deviennent immuables par toute personne autre que le créateur de la transaction, ce qui améliore considérablement la mise en œuvre de nombreux autres protocoles qui reposent sur la construction avancée de transactions bitcoin, tels que les canaux de paiement, les transactions chaînées et les réseaux Lightning.</p>
</dd>
<dt class="hdlist1">Gestion des versions de script </dt>
<dd>
<p>Avec l&#8217;introduction des scripts Segregated Witness (témoin séparé), chaque script de verrouillage est précédé d&#8217;un numéro de <em>version de script</em>, similaire à la façon dont les transactions et les blocs ont des numéros de version. L&#8217;ajout d&#8217;un numéro de version de script permet au langage de script d&#8217;être mis à niveau de manière rétrocompatible (c&#8217;est-à-dire en utilisant des mises à niveau d&#8217;embranchement convergent) pour introduire de nouvelles opérandes de script, syntaxe ou sémantique. La possibilité de mettre à niveau le langage de script de manière non perturbatrice accélérera considérablement le taux d&#8217;innovation dans le bitcoin.</p>
</dd>
<dt class="hdlist1">Mise à l&#8217;échelle du réseau et du stockage </dt>
<dd>
<p>Les données témoins contribuent souvent de manière importante à la taille totale d&#8217;une transaction. Les scripts plus complexes tels que ceux utilisés pour les canaux multisig ou de paiement sont très volumineux. Dans certains cas, ces scripts représentent la majorité (plus de 75 %) des données d&#8217;une transaction. En déplaçant les données témoins en dehors des données de transaction, le témoin séparé améliore l&#8217;évolutivité de Bitcoin. Les nœuds peuvent élaguer les données témoins après avoir validé les signatures, ou les ignorer complètement lors de la vérification simplifiée des paiements. Les données témoins n&#8217;ont pas besoin d&#8217;être transmises à tous les nœuds et n&#8217;ont pas besoin d&#8217;être stockées sur disque par tous les nœuds.</p>
</dd>
<dt class="hdlist1">Optimisation de la vérification de signature </dt>
<dd>
<p>Le témoin séparé met à niveau les fonctions de signature (CHECKSIG, CHECKMULTISIG, etc.) pour réduire la complexité de calcul de l&#8217;algorithme. Avant segwit, l&#8217;algorithme utilisé pour produire une signature nécessitait un nombre d&#8217;opérations de hachage proportionnel à la taille de la transaction. Les calculs de hachage de données ont augmenté en O(n<sup>2</sup>) par rapport au nombre d&#8217;opérations de signature, introduisant une charge de calcul substantielle sur tous les nœuds vérifiant la signature. Avec segwit, l&#8217;algorithme est modifié pour réduire la complexité à O(n).</p>
</dd>
<dt class="hdlist1">Amélioration de la signature hors ligne </dt>
<dd>
<p>Les signatures des témoins séparés incorporent la valeur (montant) référencée par chaque entrée dans le hachage qui est signé. Auparavant, un dispositif de signature hors ligne, tel qu&#8217;un portefeuille matériel, devait vérifier le montant de chaque entrée avant de signer une transaction. Cela était généralement accompli en diffusant une grande quantité de données sur les transactions précédentes référencées en tant qu&#8217;entrées. Étant donné que le montant fait désormais partie du hachage d&#8217;engagement qui est signé, un appareil hors ligne n&#8217;a pas besoin des transactions précédentes. Si les montants ne correspondent pas (sont mal représentés par un système en ligne compromis), la signature sera invalide.</p>
</dd>
</dl>
</div>
</div>
<div class="sect3 data-line-682">
<h4 id="_comment_fonctionne_le_témoignage_séparé">Comment fonctionne le témoignage séparé</h4>
<div class="paragraph data-line-684">
<p>À première vue, le témoignage séparé semble être un changement dans la façon dont les transactions sont construites et donc une fonctionnalité au niveau de la transaction, mais ce n&#8217;est pas le cas. Au lieu de cela, le témoin séparé est un changement dans la façon dont les UTXO individuels sont dépensés et est donc une fonctionnalité par sortie.</p>
</div>
<div class="paragraph data-line-686">
<p>Une transaction peut dépenser des sorties de témoin séparé ou des sorties traditionnelles (témoin en ligne) ou les deux. Par conséquent, cela n&#8217;a pas beaucoup de sens de se référer à une transaction comme une "transaction de témoin séparé". Nous devrions plutôt faire référence à des sorties de transaction spécifiques en tant que "sorties de témoins séparés".</p>
</div>
<div class="paragraph data-line-688">
<p>Lorsqu&#8217;une transaction passe un UTXO, elle doit fournir un témoin. Dans un UTXO traditionnel, le script de verrouillage nécessite que les données témoins soient fournies <em>en ligne</em> dans la partie d&#8217;entrée de la transaction qui dépense l&#8217;UTXO. Un UTXO de témoin séparé, cependant, spécifie un script de verrouillage qui peut être satisfait avec des données de témoin en dehors de l&#8217;entrée (séparées).</p>
</div>
</div>
<div class="sect3 data-line-690">
<h4 id="_embranchement_convergent_rétrocompatibilité">Embranchement convergent (rétrocompatibilité)</h4>
<div class="paragraph data-line-692">
<p>Le témoin séparé est un changement significatif dans la manière dont les sorties et les transactions sont architecturées. Un tel changement nécessiterait normalement un changement simultané de chaque nœud et portefeuille Bitcoin pour modifier les règles de consensus, ce que l&#8217;on appelle une fourche dure. Au lieu de cela, un témoin séparé est introduit avec un changement beaucoup moins perturbateur, qui est rétrocompatible, connu sous le nom d&#8217;embranchement convergent. Ce type de mise à niveau permet aux logiciels non mis à niveau d&#8217;ignorer les modifications et de continuer à fonctionner sans aucune interruption.</p>
</div>
<div class="paragraph data-line-694">
<p>Les sorties de témoins séparés sont construites de manière à ce que les systèmes plus anciens qui ne sont pas sensibles au segwit puissent toujours les valider. Pour un ancien portefeuille ou nœud, une sortie de témoin séparé ressemble à une sortie que <em>n&#8217;importe qui peut dépenser</em>. De telles sorties peuvent être dépensées avec une signature vide, donc le fait qu&#8217;il n&#8217;y ait pas de signature à l&#8217;intérieur de la transaction (elle est séparée) n&#8217;invalide pas la transaction. Cependant, les portefeuilles et les nœuds de minage plus récents voient la sortie du témoin séparé et s&#8217;attendent à trouver un témoin valide pour celle-ci dans les données de témoin de la transaction.</p>
</div>
</div>
<div class="sect3 data-line-696">
<h4 id="_exemples_de_témoins_séparés_et_exemples_de_transactions">Exemples de témoins séparés et exemples de transactions</h4>
<div class="paragraph data-line-698">
<p>Examinons quelques-uns de nos exemples de transactions et voyons comment ils changeraient avec le témoin séparé. Nous verrons d&#8217;abord comment un paiement Pay-to-Public-Key-Hash (P2PKH) est transformé avec le programme de témoignage séparé. Ensuite, nous examinerons l&#8217;équivalent des témoins séparés pour les scripts Pay-to-Script-Hash (P2SH). Enfin, nous verrons comment les deux programmes de témoignage séparé précédents peuvent être intégrés dans un script P2SH.</p>
</div>
<div class="sect4 data-line-701">
<h5 id="p2wpkh">Pay-to-Witness-Public-Key-Hash (P2WPKH)</h5>
<div class="paragraph data-line-703">
<p>Dans <a href="#cup_of_coffee">[cup_of_coffee]</a>, Alice a créé une transaction pour payer Bob pour une tasse de café. Cette transaction a créé une sortie P2PKH d&#8217;une valeur de 0,015 BTC pouvant être dépensée par Bob. Le script de sortie ressemble à ceci :</p>
</div>
<div class="listingblock data-line-706">
<div class="title">Exemple de script de sortie P2PKH</div>
<div class="content">
<pre>DUP HASH160 ab68025513c3dbd2f7b92a94e0581f5d50f654e7 EQUALVERIFY CHECKSIG</pre>
</div>
</div>
<div class="paragraph data-line-710">
<p>Avec le témoin séparé, Alice créerait un script Pay-to-Witness-Public-Key-Hash (P2WPKH), qui ressemble à ceci :</p>
</div>
<div class="listingblock data-line-713">
<div class="title">Exemple de script de sortie P2WPKH</div>
<div class="content">
<pre>0 ab68025513c3dbd2f7b92a94e0581f5d50f654e7</pre>
</div>
</div>
<div class="paragraph data-line-717">
<p>Comme vous pouvez le voir, le script de verrouillage d&#8217;une sortie de témoin séparé est beaucoup plus simple qu&#8217;une sortie traditionnelle. Il se compose de deux valeurs qui sont transmises à la pile d&#8217;évaluation du script. Pour un ancien client Bitcoin (non conscient de la technologie), les deux poussées ressembleraient à une sortie que n&#8217;importe qui peut dépenser et ne nécessite pas de signature (ou plutôt, peut être dépensée avec une signature vide). Pour un client segwit plus récent, le premier chiffre (0) est interprété comme un numéro de version (la <em>version témoin</em>) et la seconde partie (20 octets) est l&#8217;équivalent d&#8217;un script de verrouillage connu sous le nom de <em>programme témoin</em>. Le programme témoin de 20 octets est simplement le hachage de la clé publique, comme dans un script P2PKH.</p>
</div>
<div class="paragraph data-line-719">
<p>Examinons maintenant la transaction correspondante que Bob utilise pour dépenser cette sortie. Pour le script d&#8217;origine (nonsegwit), la transaction de Bob devrait inclure une signature dans l&#8217;entrée de transaction :</p>
</div>
<div class="listingblock data-line-722">
<div class="title">Transaction décodée montrant une sortie P2PKH dépensée avec une signature</div>
<div class="content">
<pre>[...]
“Vin” : [
"txid": "0627052b6f28912f2703066a912ea577f2ce4da4caa5a5fbd8a57286c345c2f2",
"vout": 0,
     	 "scriptSig": “&lt;Bob’s scriptSig&gt;”,
]
[...]</pre>
</div>
</div>
<div class="paragraph data-line-732">
<p>Cependant, pour passer la sortie du témoin séparé, la transaction n&#8217;a pas de signature dans la partie d&#8217;entrée. Au lieu de cela, la transaction de Bob a un <code>scriptSig</code> vide dans les données de transaction (la première partie d&#8217;une transaction, qui inclut la partie d&#8217;entrée) et inclut sa signature dans les données témoins (la deuxième partie d&#8217;une transaction, qui est séparée des données de transaction ):</p>
</div>
<div class="listingblock data-line-735">
<div class="title">Transaction décodée montrant une sortie P2WPKH dépensée avec des données témoins séparées</div>
<div class="content">
<pre>[...]
“Vin” : [
"txid": "0627052b6f28912f2703066a912ea577f2ce4da4caa5a5fbd8a57286c345c2f2",
"vout": 0,
     	 "scriptSig": “”,
]
[...]
“witness”: “&lt;Bob’s witness data&gt;”
[...]</pre>
</div>
</div>
</div>
<div class="sect4 data-line-747">
<h5 id="_construction_de_portefeuille_de_p2wpkh">Construction de portefeuille de P2WPKH</h5>
<div class="paragraph data-line-749">
<p>Il est extrêmement important de noter que P2WPKH ne doit être créé que par le bénéficiaire (destinataire) et non converti par l&#8217;expéditeur à partir d&#8217;une clé publique connue, d&#8217;un script P2PKH ou d&#8217;une adresse. Le destinataire n&#8217;a aucun moyen de savoir si le portefeuille de l&#8217;expéditeur a la capacité de construire des transactions segwit et de dépenser les sorties P2WPKH.</p>
</div>
<div class="paragraph data-line-751">
<p>De plus, les sorties P2WPKH doivent être construites à partir du hachage d&#8217;une clé publique <em>compressée</em>. Les clés publiques non compressées ne sont pas standard dans segwit et peuvent être explicitement désactivées par un futur embranchement convergent. Si le hachage utilisé dans le P2WPKH provient d&#8217;une clé publique non compressée, il peut être inutilisable et vous risquez de perdre des fonds. Les sorties P2WPKH doivent être créées par le portefeuille du bénéficiaire en dérivant une clé publique compressée à partir de sa clé privée.</p>
</div>
<div class="admonitionblock warning data-line-754">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph data-line-755">
<p>P2WPKH doit être construit par le bénéficiaire (destinataire) en convertissant une clé publique compressée en un hachage P2WPKH. Vous ne devez jamais transformer un script P2PKH, une adresse Bitcoin ou une clé publique non compressée en un script témoin P2WPKH.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4 data-line-759">
<h5 id="p2wsh">Pay-to-Witness-Script-Hash (P2WSH)</h5>
<div class="paragraph data-line-761">
<p>Le deuxième type de programme témoin correspond à un script Pay-to-Script-Hash (P2SH). Nous avons vu ce type de script dans <a href="#p2sh">Pay-to-Script-Hash (P2SH)</a>. Dans cet exemple, P2SH a été utilisé par la société de Mohammed pour exprimer un script multisignature. Les paiements à l&#8217;entreprise de Mohammed étaient encodés avec un script de verrouillage comme celui-ci :</p>
</div>
<div class="listingblock data-line-764">
<div class="title">Exemple de script de sortie P2SH</div>
<div class="content">
<pre>HASH160 54c557e07dde5bb6cb791c7a540e0a4796f5e97e EQUAL</pre>
</div>
</div>
<div class="paragraph data-line-768">
<p>Ce script P2SH fait référence au hachage d&#8217;un <em>script d&#8217;échange</em> qui définit une exigence multisignature 2 sur 5 pour dépenser des fonds. Pour dépenser cette sortie, la société de Mohammed présenterait le script de rachat (dont le hachage correspond au hachage du script dans la sortie P2SH) et les signatures nécessaires pour satisfaire ce script de rachat, le tout dans l&#8217;entrée de transaction :</p>
</div>
<div class="listingblock data-line-771">
<div class="title">Transaction décodée montrant qu&#8217;une sortie P2SH est dépensée</div>
<div class="content">
<pre>[...]
“Vin” : [
"txid": "abcdef12345...",
"vout": 0,
     	 "scriptSig": “&lt;SigA&gt; &lt;SigB&gt; &lt;2 PubA PubB PubC PubD PubE 5 CHECKMULTISIG&gt;”,
]</pre>
</div>
</div>
<div class="paragraph data-line-780">
<p>Maintenant, regardons comment cet exemple entier serait mis à niveau vers segwit. Si les clients de Mohammed utilisaient un portefeuille compatible segwit, ils effectueraient un paiement, créant une sortie Pay-to-Witness-Script-Hash (P2WSH) qui ressemblerait à ceci :</p>
</div>
<div class="listingblock data-line-783">
<div class="title">Exemple de script de sortie P2WSH</div>
<div class="content">
<pre>0 a9b7b38d972cabc7961dbfbcb841ad4508d133c47ba87457b4a0e8aae86dbb89</pre>
</div>
</div>
<div class="paragraph data-line-787">
<p>Encore une fois, comme dans l&#8217;exemple de P2WPKH, vous pouvez voir que le script équivalent Segregated Witness est beaucoup plus simple et omet les différents opérandes de script que vous voyez dans les scripts P2SH. Au lieu de cela, le programme de témoignage séparé se compose de deux valeurs poussées vers la pile : une version témoin (0) et le hachage SHA256 de 32 octets du script de rachat.</p>
</div>
<div class="paragraph data-line-789">
<p>La société de Mohammed peut dépenser la sortie P2WSH en présentant le bon script de rachat et suffisamment de signatures pour le satisfaire. Le script de rachat et les signatures seraient séparés <em>en dehors</em> des données de transaction de dépenses dans le cadre des données de témoin. Dans l&#8217;entrée de transaction, le portefeuille de Mohammed mettrait un <code>scriptSig</code> vide :</p>
</div>
<div class="listingblock data-line-792">
<div class="title">Transaction décodée montrant une sortie P2WSH dépensée avec des données témoins séparées</div>
<div class="content">
<pre>[...]
“Vin” : [
"txid": "abcdef12345...",
"vout": 0,
     	 "scriptSig": “”,
]
[...]
“witness”: “&lt;SigA&gt; &lt;SigB&gt; &lt;2 PubA PubB PubC PubD PubE 5 CHECKMULTISIG&gt;”
[...]</pre>
</div>
</div>
<div class="admonitionblock tip data-line-805">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph data-line-806">
<p>Alors que P2SH utilise le hachage <code>RIPEMD160(SHA256(script))</code> de 20 octets, le programme témoin P2WSH utilise un hachage <code>SHA256(script)</code> de 32 octets. Cette différence dans le choix de l&#8217;algorithme de hachage est délibérée et offre une sécurité renforcée à P2WSH (128 bits de sécurité dans P2WSH contre 80 bits de sécurité dans P2SH). Il est également utilisé pour différencier les deux types de programmes témoins (P2WPKH et P2WSH) en utilisant la longueur du hachage (voir ci-dessous).</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4 data-line-810">
<h5 id="_différenciation_entre_p2wpkh_et_p2wsh">Différenciation entre P2WPKH et P2WSH</h5>
<div class="paragraph data-line-812">
<p>Dans les deux sections précédentes, nous avons présenté deux types de programmes de témoins : <a href="#p2wpkh">Pay-to-Witness-Public-Key-Hash (P2WPKH)</a> et <a href="#p2wsh">Pay-to-Witness-Script-Hash (P2WSH)</a>. Les deux types de programmes témoins se composent d&#8217;un numéro de version à un seul octet suivi d&#8217;un hachage plus long. Ils se ressemblent beaucoup, mais sont interprétés très différemment : l&#8217;un est interprété comme un hachage de clé publique, qui est satisfait par une signature et l&#8217;autre comme un hachage de script, qui est satisfait par un script de rachat. La différence critique entre eux est la longueur du hachage :</p>
</div>
<div class="ulist data-line-814">
<ul>
<li class="data-line-814">
<p>Le hachage de clé publique dans P2WPKH est de 20 octets</p>
</li>
<li class="data-line-815">
<p>Le hachage du script dans P2WSH est de 32 octets</p>
</li>
</ul>
</div>
<div class="paragraph data-line-817">
<p>C&#8217;est la seule différence qui permet à un portefeuille de différencier les deux types de programmes de témoins. En examinant la longueur du hachage, un portefeuille peut déterminer de quel type de programme témoin il s&#8217;agit, P2WPKH ou P2WSH.</p>
</div>
</div>
</div>
<div class="sect3 data-line-819">
<h4 id="_mise_à_niveau_vers_un_témoin_séparé">Mise à niveau vers un témoin séparé</h4>
<div class="paragraph data-line-821">
<p>Comme nous pouvons le voir dans les exemples précédents, la mise à niveau vers les témoins séparés est un processus en deux étapes. Tout d&#8217;abord, les portefeuilles doivent créer des sorties spéciales de type segwit. Ensuite, ces sorties peuvent être dépensées par des portefeuilles qui savent comment construire des transactions de témoin séparé. Dans les exemples, le portefeuille d&#8217;Alice était sensible au segwit et capable de créer des sorties spéciales avec des scripts de témoignage séparés. Le portefeuille de Bob est également sensible au segwit et capable de dépenser ces sorties. Ce qui n&#8217;est peut-être pas évident à partir de l&#8217;exemple, c&#8217;est qu&#8217;en pratique, le portefeuille d&#8217;Alice doit <em>savoir</em> que Bob utilise un portefeuille sensible au segwit et peut dépenser ces sorties. Sinon, si le portefeuille de Bob n&#8217;est pas mis à niveau et qu&#8217;Alice essaie d&#8217;effectuer des paiements en segwit à Bob, le portefeuille de Bob ne pourra pas détecter ces paiements.</p>
</div>
<div class="admonitionblock tip data-line-824">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph data-line-825">
<p>Pour les types de paiement P2WPKH et P2WSH, les portefeuilles de l&#8217;expéditeur et du destinataire doivent être mis à niveau pour pouvoir utiliser segwit. De plus, le portefeuille de l&#8217;expéditeur doit savoir que le portefeuille du destinataire est sensible au segwit.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph data-line-828">
<p>Le témoin séparé ne sera pas mis en œuvre simultanément sur l&#8217;ensemble du réseau. Au lieu de cela, Segregated Witness est implémenté comme une mise à niveau rétrocompatible, où <em>les anciens et les nouveaux clients peuvent coexister</em>. Les développeurs de portefeuille mettront indépendamment à niveau le logiciel de portefeuille pour ajouter des fonctionnalités segwit. Les types de paiement P2WPKH et P2WSH sont utilisés lorsque l&#8217;expéditeur et le destinataire sont conscients de segwit. Les P2PKH et P2SH traditionnels continueront de fonctionner pour les portefeuilles non mis à niveau. Cela laisse deux scénarios importants, qui sont abordés dans la section suivante :</p>
</div>
<div class="ulist data-line-830">
<ul>
<li class="data-line-830">
<p>Capacité du portefeuille d&#8217;un expéditeur qui n&#8217;est pas conscient de segwit à effectuer un paiement sur le portefeuille d&#8217;un destinataire qui peut traiter des transactions segwit</p>
</li>
<li class="data-line-832">
<p>Capacité du portefeuille d&#8217;un expéditeur qui est conscient de segwit à reconnaître et à distinguer les destinataires qui sont conscients de segwit et ceux qui ne le sont pas, par leurs <em>adresses</em>.</p>
</li>
</ul>
</div>
<div class="sect4 data-line-834">
<h5 id="_intégration_dun_témoin_séparé_dans_p2sh">Intégration d&#8217;un témoin séparé dans P2SH</h5>
<div class="paragraph data-line-836">
<p>Supposons, par exemple, que le portefeuille d&#8217;Alice n&#8217;est pas mis à niveau vers segwit, mais que le portefeuille de Bob est mis à niveau et peut gérer les transactions segwit. Alice et Bob peuvent utiliser les "anciennes" transactions non-segwit. Mais Bob voudrait probablement utiliser segwit pour réduire les frais de transaction, en profitant de la remise qui s&#8217;applique aux données des témoins.</p>
</div>
<div class="paragraph data-line-838">
<p>Dans ce cas, le portefeuille de Bob peut construire une adresse P2SH qui contient un script segwit à l&#8217;intérieur. Le portefeuille d&#8217;Alice considère cela comme une adresse P2SH "normale" et peut y effectuer des paiements sans aucune connaissance de segwit. Le portefeuille de Bob peut ensuite dépenser ce paiement avec une transaction segwit, tirant pleinement parti de segwit et réduisant les frais de transaction.</p>
</div>
<div class="paragraph data-line-840">
<p>Les deux formes de scripts témoins, P2WPKH et P2WSH, peuvent être intégrées dans une adresse P2SH. Le premier est noté P2SH(P2WPKH) et le second est noté P2SH(P2WSH).</p>
</div>
</div>
<div class="sect4 data-line-842">
<h5 id="_pay_to_witness_public_key_hash_dans_pay_to_script_hash">Pay-to-Witness-Public-Key-Hash dans Pay-to-Script-Hash</h5>
<div class="paragraph data-line-844">
<p>La première forme de script témoin que nous examinerons est P2SH(P2WPKH). Il s&#8217;agit d&#8217;un programme témoin Pay-to-Witness-Public-Key-Hash, intégré dans un script Pay-to-Script-Hash, afin qu&#8217;il puisse être utilisé par un portefeuille qui n&#8217;est pas conscient de segwit.</p>
</div>
<div class="paragraph data-line-846">
<p>Le portefeuille de Bob construit un programme témoin P2WPKH avec la clé publique de Bob. Ce programme témoin est ensuite haché et le hachage résultant est encodé sous la forme d&#8217;un script P2SH. Le script P2SH est converti en une adresse Bitcoin, celle qui commence par un "3", comme nous l&#8217;avons vu dans le <a href="#p2sh">Pay-to-Script-Hash (P2SH)</a> rubrique.</p>
</div>
<div class="paragraph data-line-848">
<p>Le portefeuille de Bob commence par le programme témoin P2WPKH que nous avons vu plus tôt :</p>
</div>
<div class="listingblock data-line-851">
<div class="title">Programme de témoins P2WPKH de Bob</div>
<div class="content">
<pre>0 ab68025513c3dbd2f7b92a94e0581f5d50f654e7</pre>
</div>
</div>
<div class="paragraph data-line-855">
<p>Le programme témoin P2WPKH se compose de la version témoin et du hachage de clé publique de 20 octets de Bob.</p>
</div>
<div class="paragraph data-line-857">
<p>Le portefeuille de Bob hache ensuite le programme témoin précédent, d&#8217;abord avec SHA256, puis avec RIPEMD160, produisant un autre hachage de 20 octets.</p>
</div>
<div class="paragraph data-line-859">
<p>Utilisons <code>bx</code> sur la ligne de commande pour répliquer cela :</p>
</div>
<div class="listingblock data-line-862">
<div class="title">HASH160 du programme témoin P2WPKH</div>
<div class="content">
<pre>echo \
'0 [ab68025513c3dbd2f7b92a94e0581f5d50f654e7]'\
 | bx script-encode | bx sha256 | bx ripemd160
3e0547268b3b19288b3adef9719ec8659f4b2b0b</pre>
</div>
</div>
<div class="paragraph data-line-870">
<p>Ensuite, le hachage du script de rachat est converti en une adresse Bitcoin. Utilisons à nouveau <code>bx</code> sur la ligne de commande :</p>
</div>
<div class="listingblock data-line-873">
<div class="title">Adresse P2SH</div>
<div class="content">
<pre>echo \
'3e0547268b3b19288b3adef9719ec8659f4b2b0b' \
| bx address-encode -v 5
37Lx99uaGn5avKBxiW26HjedQE3LrDCZru</pre>
</div>
</div>
<div class="paragraph data-line-880">
<p>Maintenant, Bob peut afficher cette adresse pour que les clients paient leur café. Le portefeuille d&#8217;Alice peut effectuer un paiement au 37Lx99uaGn5avKBxiW26HjedQE3LrDCZru, comme il le ferait avec n&#8217;importe quelle autre adresse Bitcoin.</p>
</div>
<div class="paragraph data-line-882">
<p>Pour payer Bob, le portefeuille d&#8217;Alice verrouillerait la sortie avec un script P2SH :</p>
</div>
<div class="listingblock data-line-883">
<div class="content">
<pre>HASH160 3e0547268b3b19288b3adef9719ec8659f4b2b0b EQUAL</pre>
</div>
</div>
<div class="paragraph data-line-887">
<p>Même si le portefeuille d&#8217;Alice ne prend pas en charge segwit, le paiement qu&#8217;il crée peut être dépensé par Bob avec une transaction segwit.</p>
</div>
</div>
<div class="sect4 data-line-889">
<h5 id="_pay_to_witness_script_hash_dans_pay_to_script_hash">Pay-to-Witness-Script-Hash dans Pay-to-Script-Hash</h5>
<div class="paragraph data-line-891">
<p>De même, un programme témoin P2WSH pour un script multisig ou un autre script compliqué peut être intégré dans un script et une adresse P2SH, permettant à n&#8217;importe quel portefeuille d&#8217;effectuer des paiements compatibles avec segwit.</p>
</div>
<div class="paragraph data-line-893">
<p>Comme nous l&#8217;avons vu dans <a href="#p2wsh">Pay-to-Witness-Script-Hash (P2WSH)</a>, la société de Mohammed  utilise des paiements de témoins séparés avec des scripts multisignatures. Pour permettre à tout client de payer son entreprise, que ses portefeuilles soient ou non mis à niveau pour segwit, le portefeuille de Mohammed peut intégrer le programme témoin P2WSH dans un script P2SH.</p>
</div>
<div class="paragraph data-line-895">
<p>Tout d&#8217;abord, le portefeuille de Mohammed hache le script de rachat avec SHA256 (une seule fois). Utilisons <code>bx</code> pour faire cela sur la ligne de commande :</p>
</div>
<div class="listingblock data-line-898">
<div class="title">Le portefeuille de Mohammed crée un programme témoin P2WSH</div>
<div class="content">
<pre>echo \
2 \ [04C16B8698A9ABF84250A7C3EA7EEDEF9897D1C8C6ADF47F06CF73370D74DCCA01CDCA79DCC5C395D7EEC6984D83F1F50C900A24DD47F569FD4193AF5DE762C587] \
[04A2192968D8655D6A935BEAF2CA23E3FB87A3495E7AF308EDF08DAC3C1FCBFC2C75B4B0F4D0B1B70CD2423657738C0C2B1D5CE65C97D78D0E34224858008E8B49] \
[047E63248B75DB7379BE9CDA8CE5751D16485F431E46117B9D0C1837C9D5737812F393DA7D4420D7E1A9162F0279CFC10F1E8E8F3020DECDBC3C0DD389D9977965] \
[0421D65CBD7149B255382ED7F78E946580657EE6FDA162A187543A9D85BAAA93A4AB3A8F044DADA618D087227440645ABE8A35DA8C5B73997AD343BE5C2AFD94A5] \
[043752580AFA1ECED3C68D446BCAB69AC0BA7DF50D56231BE0AABF1FDEEC78A6A45E394BA29A1EDF518C022DD618DA774D207D137AAB59E0B000EB7ED238F4D800] \
5 CHECKMULTISIG \
| bx script-encode | bx sha256
9592d601848d04b172905e0ddb0adde59f1590f1e553ffc81ddc4b0ed927dd73</pre>
</div>
</div>
<div class="paragraph data-line-910">
<p>Ensuite, le script de rachat haché est transformé en un programme témoin P2WSH :</p>
</div>
<div class="listingblock data-line-912">
<div class="content">
<pre>0 9592d601848d04b172905e0ddb0adde59f1590f1e553ffc81ddc4b0ed927dd73</pre>
</div>
</div>
<div class="paragraph data-line-916">
<p>Ensuite, le programme témoin lui-même est haché avec SHA256 et RIPEMD160, produisant un nouveau hachage de 20 octets, tel qu&#8217;utilisé dans le P2SH traditionnel. Utilisons <code>bx</code> sur la ligne de commande pour faire cela :</p>
</div>
<div class="listingblock data-line-919">
<div class="title">Le HASH160 du programme témoin P2WSH</div>
<div class="content">
<pre> echo \
'0 [9592d601848d04b172905e0ddb0adde59f1590f1e553ffc81ddc4b0ed927dd73]'\
 | bx script-encode | bx sha256 | bx ripemd160
86762607e8fe87c0c37740cddee880988b9455b2</pre>
</div>
</div>
<div class="paragraph data-line-926">
<p>Ensuite, le portefeuille construit une adresse Bitcoin P2SH à partir de ce hachage. Encore une fois, nous utilisons <code>bx</code> pour calculer sur la ligne de commande :</p>
</div>
<div class="listingblock data-line-929">
<div class="title">P2SH Adresse bitcoin</div>
<div class="content">
<pre>echo \
'86762607e8fe87c0c37740cddee880988b9455b2'\
 | bx address-encode -v 5
3Dwz1MXhM6EfFoJChHCxh1jWHb8GQqRenG</pre>
</div>
</div>
<div class="paragraph data-line-936">
<p>Désormais, les clients de Mohammed peuvent effectuer des paiements à cette adresse sans avoir besoin de prendre en charge segwit. Pour envoyer un paiement à Mohammed, un portefeuille verrouillerait la sortie avec le script P2SH suivant :</p>
</div>
<div class="listingblock data-line-939">
<div class="title">Script P2SH utilisé pour verrouiller les paiements sur le multisig de Mohammed</div>
<div class="content">
<pre>HASH160 86762607e8fe87c0c37740cddee880988b9455b2 EQUAL</pre>
</div>
</div>
<div class="paragraph data-line-943">
<p>La société de Mohammed peut alors construire des transactions segwit pour dépenser ces paiements, en tirant parti des fonctionnalités segwit, notamment des frais de transaction moins élevés.</p>
</div>
</div>
<div class="sect4 data-line-945">
<h5 id="_adresses_de_témoins_séparés">Adresses de témoins séparés</h5>
<div class="paragraph data-line-947">
<p>Même après l&#8217;activation de segwit, il faudra un certain temps avant que la plupart des portefeuilles soient mis à niveau. Dans un premier temps, segwit sera intégré à P2SH, comme nous l&#8217;avons vu dans la section précédente, pour faciliter la compatibilité entre les portefeuilles prenant en charge et ignorants de segwit.</p>
</div>
<div class="paragraph data-line-949">
<p>Cependant, une fois que les portefeuilles prennent largement en charge segwit, il est logique d&#8217;encoder les scripts témoins directement dans un format d&#8217;adresse natif conçu pour segwit, plutôt que de l&#8217;intégrer dans P2SH.</p>
</div>
<div class="paragraph data-line-951">
<p>Le format d&#8217;adresse segwit natif est défini dans BIP-173 :</p>
</div>
<div class="dlist data-line-953">
<dl>
<dt class="hdlist1"><a href="https://github.com/bitcoin/bips/blob/master/bip-0173.mediawiki" data-href="https://github.com/bitcoin/bips/blob/master/bip-0173.mediawiki">BIP-173</a> </dt>
<dd>
<p>Format d&#8217;adresse Base32 pour les sorties témoins natives v0-16</p>
</dd>
</dl>
</div>
<div class="paragraph data-line-955">
<p>BIP-173 encode uniquement les scripts témoins (P2WPKH et P2WSH). Il n&#8217;est pas compatible avec les scripts P2PKH ou P2SH non-segwit. BIP-173 est un encodage Base32 à somme de contrôle, par rapport à l&#8217;encodage Base58 d&#8217;une adresse Bitcoin "traditionnelle". Les adresses BIP-173 sont également appelées adresses <em>bech32</em>, prononcées "beh-ch trente-deux", faisant allusion à l&#8217;utilisation d&#8217;un algorithme de détection d&#8217;erreur "BCH" et d&#8217;un ensemble de codage à 32 caractères.</p>
</div>
<div class="paragraph data-line-957">
<p>Les adresses BIP-173 utilisent un jeu de 32 caractères alphanumériques en minuscules uniquement, soigneusement sélectionnés pour réduire les erreurs de lecture ou de frappe. En choisissant un jeu de caractères en minuscules uniquement, bech32 est plus facile à lire, à parler et 45 % plus efficace pour encoder dans les codes QR.</p>
</div>
<div class="paragraph data-line-959">
<p>L&#8217;algorithme de détection d&#8217;erreurs BCH est une grande amélioration par rapport à l&#8217;algorithme de somme de contrôle précédent (de Base58Check), permettant non seulement la détection mais aussi la <em>correction</em> des erreurs. Les interfaces de saisie d&#8217;adresse (telles que les champs de texte dans les formulaires) peuvent détecter et mettre en évidence le caractère le plus susceptible d&#8217;être mal saisi lorsqu&#8217;elles détectent une erreur.</p>
</div>
<div class="paragraph data-line-961">
<p>De la spécification BIP-173, voici quelques exemples d&#8217;adresses bech32 :</p>
</div>
<div class="dlist data-line-963">
<dl>
<dt class="hdlist1">Mainnet P2WPKH</dt>
<dd>
<p>bc1qw508d6qejxtdg4y5r3zarvary0c5xw7kv8f3t4</p>
</dd>
<dt class="hdlist1">Testnet P2WPKH</dt>
<dd>
<p>tb1qw508d6qejxtdg4y5r3zarvary0c5xw7kxpjzsx</p>
</dd>
<dt class="hdlist1">Mainnet P2WSH</dt>
<dd>
<p>bc1qrp33g0q5c5txsp9arysrx4k6zdkfs4nce4xj0gdcccefvpysxf3qccfmv3</p>
</dd>
<dt class="hdlist1">Testnet P2WSH</dt>
<dd>
<p>tb1qrp33g0q5c5txsp9arysrx4k6zdkfs4nce4xj0gdcccefvpysxf3q0sl5k7</p>
</dd>
</dl>
</div>
<div class="paragraph data-line-968">
<p>Comme vous pouvez le voir dans ces exemples, une chaîne segwit bech32 contient jusqu&#8217;à 90 caractères et se compose de trois parties :</p>
</div>
<div class="dlist data-line-970">
<dl>
<dt class="hdlist1">La partie lisible par l&#8217;homme</dt>
<dd>
<p>Ce préfixe "bc" ou "tb" identifiant mainnet ou testnet</p>
</dd>
<dt class="hdlist1">Le séparateur</dt>
<dd>
<p>Le chiffre "1", qui ne fait pas partie du jeu de codage à 32 caractères et ne peut apparaître qu&#8217;à cette position en tant que séparateur</p>
</dd>
<dt class="hdlist1">La partie données</dt>
<dd>
<p>Un minimum de 6 caractères alphanumériques, le script témoin encodé par somme de contrôle</p>
</dd>
</dl>
</div>
<div class="paragraph data-line-976">
<p>À l&#8217;heure actuelle, seuls quelques portefeuilles acceptent ou produisent des adresses segwit bech32 natives, mais à mesure que l&#8217;adoption de segwit augmente, vous les verrez de plus en plus souvent.</p>
</div>
<div class="paragraph data-line-978">
<p><a href="#segwit_addresses">Bitcoin non-segwit (hérité) et adresses segwit</a> affiche les adresses bitcoin non-segwit (héritées) et segwit.</p>
</div>
<table id="segwit_addresses" class="tableblock frame-all grid-all stretch data-line-982">
<caption class="title">Table 3. Bitcoin non-segwit (hérité) et adresses segwit</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Type</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Encodage</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Préfixe</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Adresse P2PKH héritée</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Base58</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Ancienne adresse Testnet P2PKH</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Base58</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">m ou n</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Ancienne adresse P2SH</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Base58</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Ancienne adresse Testnet P2SH</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Base58</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Adresse Segwit P2SH(P2WPKH) imbriquée (intégrée)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Base58</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Adresse Segwit P2SH(P2WSH) imbriquée (intégrée)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Base58</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Adresse native Segwit P2WPKH</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Bech32</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">bc1</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Adresse native Segwit Testnet P2WPKH</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Bech32</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">tb1</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Adresse native Segwit P2WSH</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Bech32</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">bc1</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Adresse native Segwit Testnet P2WSH</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Bech32</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">tb1</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect4 data-line-997">
<h5 id="segwit_txid">Identifiants de transaction</h5>
<div class="paragraph data-line-999">
<p>L&#8217;un des plus grands avantages des témoin séparés est qu&#8217;il élimine la malléabilité des transactions tierces.</p>
</div>
<div class="paragraph data-line-1001">
<p>Avant segwit, les transactions pouvaient voir leurs signatures subtilement modifiées par des tiers, changeant leur ID de transaction (hachage) sans changer aucune propriété fondamentale (entrées, sorties, montants). Cela a créé des opportunités d&#8217;attaques par déni de service ainsi que des attaques contre des logiciels de portefeuille mal écrits qui supposaient que les hachages de transaction non confirmés étaient immuables.</p>
</div>
<div class="paragraph data-line-1003">
<p>Avec l&#8217;introduction des témoins séparés, les transactions ont deux identifiants, <code>txid</code> et wtxid. L&#8217;identifiant de transaction traditionnel <code>txid</code> est le hachage double SHA256 de la transaction sérialisée, sans les données témoins. Une transaction <code>wtxid</code> est le hachage double SHA256 du nouveau format de sérialisation de la transaction avec des données témoins.</p>
</div>
<div class="paragraph data-line-1005">
<p>Le <code>txid</code> traditionnel est calculé exactement de la même manière qu&#8217;avec une transaction non segwit. Cependant, étant donné qu&#8217;une transaction segwit pure (une transaction qui ne contient que des entrées segwit) a des <code>scriptSig</code> vides dans chaque entrée, aucune partie de la transaction ne peut être modifiée par un tiers. Par conséquent, dans une transaction segwit pure, le <code>txid</code> est immuable par un tiers, même lorsque la transaction n&#8217;est pas confirmée.</p>
</div>
<div class="paragraph data-line-1007">
<p>Le <code>wtxid</code> est comme un identifiant "étendu", en ce que le hachage incorpore également les données du témoin. Si une transaction est transmise sans données témoins, alors le <code>wtxid</code> et le <code>txid</code> sont identiques. Notez que puisque le <code>wtxid</code> inclut des données témoins (signatures) et que les données témoins peuvent être malléables, le <code>wtxid</code> doit être considéré comme malléable jusqu&#8217;à ce que la transaction soit confirmée. Seul le <code>txid</code> d&#8217;une pure transaction segwit peut être considéré comme immuable par des tiers.</p>
</div>
<div class="admonitionblock tip data-line-1010">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph data-line-1011">
<p>Les transactions de témoin séparé ont deux identifiants : <code>txid</code> et wtxid. Le <code>txid</code> est le hachage de la transaction sans les données témoins et le <code>wtxid</code> est le hachage incluant les données témoins. Seules les transactions segwit pures (transactions qui ne contiennent que des entrées segwit) ont un <code>txid</code> qui n&#8217;est pas sensible à la malléabilité des transactions tierces.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3 data-line-1014">
<h4 id="_nouvel_algorithme_de_signature_des_témoins_séparés">Nouvel algorithme de signature des témoins séparés</h4>
<div class="paragraph data-line-1016">
<p>Le témoin séparé modifie la sémantique des quatre fonctions de vérification de signature (CHECKSIG, CHECKSIGVERIFY, <code>CHECKMULTISIG</code> et CHECKMULTISIGVERIFY), changeant la façon dont un hachage d&#8217;engagement de transaction est calculé.</p>
</div>
<div class="paragraph data-line-1018">
<p>Les signatures dans les transactions bitcoin sont appliquées sur un <em>hachage d&#8217;engagement</em>, qui est calculé à partir des données de transaction, verrouillant des parties spécifiques des données indiquant l&#8217;engagement du signataire envers ces valeurs. Par exemple, dans une signature de type <code>SIGHASH_ALL</code> simple, le hachage d&#8217;engagement inclut toutes les entrées et sorties.</p>
</div>
<div class="paragraph data-line-1020">
<p>Malheureusement, la façon dont le hachage d&#8217;engagement a été calculé a introduit la possibilité qu&#8217;un nœud vérifiant la signature puisse être forcé d&#8217;effectuer un nombre important de calculs de hachage. Plus précisément, les opérations de hachage augmentent en O(n<sup>2</sup>) par rapport au nombre d&#8217;opérations de signature dans la transaction. Un attaquant pourrait donc créer une transaction avec un très grand nombre d&#8217;opérations de signature, obligeant l&#8217;ensemble du réseau Bitcoin à effectuer des centaines ou des milliers d&#8217;opérations de hachage pour vérifier la transaction.</p>
</div>
<div class="paragraph data-line-1022">
<p>Segwit représentait une opportunité de résoudre ce problème en modifiant la façon dont le hachage d&#8217;engagement est calculé. Pour les programmes témoins segwit version 0, la vérification de la signature se produit à l&#8217;aide d&#8217;un algorithme de hachage d&#8217;engagement amélioré, comme spécifié dans BIP-143.</p>
</div>
<div class="paragraph data-line-1024">
<p>Le nouvel algorithme atteint deux objectifs importants. Premièrement, le nombre d&#8217;opérations de hachage augmente d&#8217;un O(n) beaucoup plus graduel au nombre d&#8217;opérations de signature, réduisant la possibilité de créer des attaques par déni de service avec des transactions trop complexes. Deuxièmement, le hachage d&#8217;engagement inclut désormais également la valeur (montants) de chaque entrée dans le cadre de l&#8217;engagement. Cela signifie qu&#8217;un signataire peut s&#8217;engager sur une valeur d&#8217;entrée spécifique sans avoir besoin de "récupérer" et de vérifier la transaction précédente référencée par l&#8217;entrée. Dans le cas d&#8217;appareils hors ligne, tels que les portefeuilles matériels, cela simplifie grandement la communication entre l&#8217;hôte et le portefeuille matériel, supprimant la nécessité de diffuser les transactions précédentes pour validation. Un portefeuille matériel peut accepter la valeur d&#8217;entrée "telle qu&#8217;elle est indiquée" par un hôte non approuvé. Étant donné que la signature n&#8217;est pas valide si cette valeur d&#8217;entrée n&#8217;est pas correcte, le portefeuille matériel n&#8217;a pas besoin de valider la valeur avant de signer l&#8217;entrée.</p>
</div>
</div>
<div class="sect3 data-line-1026">
<h4 id="_incitations_économiques_pour_les_témoins_isolés">Incitations économiques pour les témoins isolés</h4>
<div class="paragraph data-line-1028">
<p>Les nœuds miniers Bitcoin et les nœuds complets entraînent des coûts pour les ressources utilisées pour prendre en charge le réseau Bitcoin et la chaîne de blocs. À mesure que le volume de transactions bitcoin augmente, le coût des ressources (CPU, bande passante réseau, espace disque, mémoire) augmente également. Les mineurs sont indemnisés pour ces coûts par des frais proportionnels à la taille (en octets) de chaque transaction. Les nœuds complets non miniers ne sont pas rémunérés, ils encourent donc ces coûts parce qu&#8217;ils ont besoin d&#8217;exécuter un nœud d&#8217;index complet faisant autorité, peut-être parce qu&#8217;ils utilisent le nœud pour exploiter une entreprise bitcoin.</p>
</div>
<div class="paragraph data-line-1030">
<p>Sans frais de transaction, la croissance des données bitcoin augmenterait sans doute de façon spectaculaire. Les frais sont destinés à aligner les besoins des utilisateurs de bitcoins sur le fardeau que leurs transactions imposent au réseau, grâce à un mécanisme de découverte des prix basé sur le marché.</p>
</div>
<div class="paragraph data-line-1032">
<p>Le calcul des frais en fonction de la taille de la transaction traite toutes les données de la transaction comme ayant un coût égal. Mais du point de vue des nœuds complets et des mineurs, certaines parties d&#8217;une transaction entraînent des coûts beaucoup plus élevés. Chaque transaction ajoutée au réseau Bitcoin affecte la consommation de quatre ressources sur les nœuds :</p>
</div>
<div class="dlist data-line-1034">
<dl>
<dt class="hdlist1">Espace disque </dt>
<dd>
<p>Chaque transaction est stockée dans la chaîne de blocs, ajoutant à la taille totale de la chaîne de blocs. La chaîne de blocs est stockée sur disque, mais le stockage peut être optimisé en « élaguant » (supprimant) les anciennes transactions.</p>
</dd>
<dt class="hdlist1">CPU </dt>
<dd>
<p>Chaque transaction doit être validée, ce qui nécessite du temps CPU.</p>
</dd>
<dt class="hdlist1">Bande passante </dt>
<dd>
<p>Chaque transaction est transmise (par propagation d&#8217;inondation) sur le réseau au moins une fois. Sans aucune optimisation du protocole de propagation de bloc, les transactions sont à nouveau transmises dans le cadre d&#8217;un bloc, ce qui double l&#8217;impact sur la capacité du réseau.</p>
</dd>
<dt class="hdlist1">Mémoire </dt>
<dd>
<p>Les nœuds qui valident les transactions conservent l&#8217;index UTXO ou l&#8217;intégralité de l&#8217;ensemble UTXO en mémoire pour accélérer la validation. Étant donné que la mémoire est au moins un ordre de grandeur plus chère que le disque, la croissance de l&#8217;ensemble UTXO contribue de manière disproportionnée au coût d&#8217;exécution d&#8217;un nœud.</p>
</dd>
</dl>
</div>
<div class="paragraph data-line-1042">
<p>Comme vous pouvez le voir dans la liste, toutes les parties d&#8217;une transaction n&#8217;ont pas le même impact sur le coût d&#8217;exécution d&#8217;un nœud ou sur la capacité du bitcoin à évoluer pour prendre en charge davantage de transactions. La partie la plus coûteuse d&#8217;une transaction sont les sorties nouvellement créées, car elles sont ajoutées à l&#8217;ensemble UTXO en mémoire. En comparaison, les signatures (c&#8217;est-à-dire les données témoins) ajoutent le moins de charge au réseau et au coût d&#8217;exécution d&#8217;un nœud, car les données témoins ne sont validées qu&#8217;une seule fois et ne sont jamais réutilisées. De plus, immédiatement après avoir reçu une nouvelle transaction et validé les données témoins, les nœuds peuvent supprimer ces données témoins. Si les frais sont calculés en fonction de la taille de la transaction, sans faire de distinction entre ces deux types de données, les incitations du marché en matière de frais ne sont pas alignées sur les coûts réels imposés par une transaction. En fait, la structure tarifaire actuelle encourage en fait le comportement inverse, car les données des témoins constituent la plus grande partie d&#8217;une transaction.</p>
</div>
<div class="paragraph data-line-1044">
<p>Les incitations créées par les frais sont importantes car elles affectent le comportement des portefeuilles. Tous les portefeuilles doivent mettre en œuvre une stratégie pour assembler les transactions qui prend en considération un certain nombre de facteurs, tels que la confidentialité (réduction de la réutilisation des adresses), la fragmentation (faire beaucoup de monnaie) et les frais. Si les frais motivent massivement les portefeuilles à utiliser le moins d&#8217;entrées possible dans les transactions, cela peut conduire à la sélection d&#8217;UTXO et à la modification des stratégies d&#8217;adresse qui gonflent par inadvertance l&#8217;ensemble UTXO.</p>
</div>
<div class="paragraph data-line-1046">
<p>Les transactions consomment les UTXO dans leurs entrées et créent de nouveaux UTXO avec leurs sorties. Par conséquent, une transaction qui a plus d&#8217;entrées que de sorties entraînera une diminution de l&#8217;ensemble UTXO, tandis qu&#8217;une transaction qui a plus de sorties que d&#8217;entrées entraînera une augmentation de l&#8217;ensemble UTXO. Considérons la <em>difference</em> entre les entrées et les sorties et appelons cela le "Net-new-UTXO". Il s&#8217;agit d&#8217;une mesure importante, car elle nous indique l&#8217;impact qu&#8217;une transaction aura sur la ressource la plus chère à l&#8217;échelle du réseau, l&#8217;ensemble UTXO en mémoire. Une transaction avec Net-new-UTXO positif ajoute à ce fardeau. Une transaction avec un Net-new-UTXO négatif réduit la charge. Nous voudrions donc encourager les transactions qui sont soit Net-new-UTXO négatives, soit neutres avec zéro Net-new-UTXO.</p>
</div>
<div class="paragraph data-line-1048">
<p>Examinons un exemple des incitations créées par le calcul des frais de transaction, avec et sans témoin séparé. Nous examinerons deux transactions différentes. La transaction A est une transaction à 3 entrées et 2 sorties, qui a une métrique Net-new-UTXO de -1, ce qui signifie qu&#8217;elle consomme un UTXO de plus qu&#8217;elle n&#8217;en crée, ce qui réduit l&#8217;UTXO défini d&#8217;un. La transaction B est une transaction à 2 entrées et 3 sorties, qui a une métrique Net-new-UTXO de 1, ce qui signifie qu&#8217;elle ajoute un UTXO à l&#8217;ensemble UTXO, imposant un coût supplémentaire à l&#8217;ensemble du réseau Bitcoin. Les deux transactions utilisent des scripts multisignatures (2 sur 3) pour démontrer comment des scripts complexes augmentent l&#8217;impact d&#8217;un témoin séparé sur les frais. Supposons un taux de transaction de 30 satoshi par octet et une remise de 75 % sur les données des témoins :</p>
</div>
<dl>
<dt>Sans témoin séparé</dt>
<dd>
<p>Frais de transaction A : 28 590 satoshi</p>
<p>Frais de transaction B : 20 760 satoshi</p>
</dd>

<dt>Avec témoin séparé</dt>
<dd>
<p>Frais de transaction A : 12 255 satoshi</p>
<p>Frais de transaction B : 10 425 satoshi</p>
</dd>
</dl>
<div class="paragraph data-line-1067">
<p>Les deux transactions sont moins coûteuses lorsque le témoin séparé est mis en œuvre. En comparant les coûts entre les deux transactions, nous voyons qu&#8217;avant le témoin séparé, la transaction avec le Net-new-UTXO positif permet de réaliser d&#8217;importantes économies. Avec le témoin séparé, la différence de coût diminue considérablement en termes absolus et relatifs. Bien qu&#8217;il faudrait que les intrants deviennent moins chers que les extrants pour inciter à la consolidation de l&#8217;ensemble UTXO, cette remise réduit l&#8217;incitation à créer de nouveaux UTXO afin d&#8217;éviter d&#8217;utiliser plus d&#8217;intrants.</p>
</div>
<div class="paragraph data-line-1069">
<p>Le témoin séparé a donc deux effets principaux sur les frais payés par les utilisateurs de bitcoin. Premièrement, segwit réduit le coût global des transactions en actualisant les données des témoins et en augmentant la capacité de la chaîne de blocs Bitcoin. Deuxièmement, la remise de segwit sur les données des témoins atténue partiellement un désalignement des incitations qui peut avoir créé par inadvertance plus de ballonnement dans l&#8217;ensemble UTXO.</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2022-03-23 23:57:01 -0400
</div>
</div>
</body>
</html>